<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Festa da Isabella</title>

<!-- Supabase JS (para o mural) -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

<style>
  :root{
    --roxo:#5b3fa2;
    --roxo-esc:#493183;
    --roxo-cl:#f1eaff;
    --bg:#fdfdfe;
    --txt:#333;
    --card-bg: rgba(255,255,255,.85);
    --shadow: 0 4px 10px rgba(0,0,0,.06);
    --radius: 14px;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;line-height:1.55;background:var(--bg);color:var(--txt)}
  a{color:var(--roxo);text-decoration:none}
  .container{max-width:960px;margin:0 auto;padding:20px}

  /* Hero */
  .hero{position:relative;background:url('hero.jpg') center/cover no-repeat;min-height:360px;height:58vh;display:flex;align-items:flex-end;justify-content:center;color:#fff;text-align:center}
  .hero::before{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.15),rgba(0,0,0,.45))}
  .hero .hero-inner{position:relative; padding:36px 20px 28px}
  .hero h1{font-size:clamp(2rem,1.2rem + 3vw,3rem);font-weight:800;letter-spacing:-.02em}
  .hero p{opacity:.95;margin-top:6px}

  /* Cards */
  .card{background:var(--card-bg);backdrop-filter:blur(8px);border-radius:var(--radius);box-shadow:var(--shadow); padding:18px 18px; margin:18px 0}
  .card h2{color:var(--roxo);font-weight:800;letter-spacing:-0.02em;font-size:clamp(1.35rem,1.1rem + 1vw,1.8rem);text-align:center;margin-bottom:10px}
  .card p.lead{text-align:center;max-width:65ch;margin:0 auto;color:#4a4a4a}

  /* Bot√µes */
  .button-row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:12px}
  .btn{display:inline-block;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer;text-align:center;border:none;transition:transform .03s ease, filter .15s ease;font-size:1rem}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--roxo);color:#fff}
  .btn-primary:hover{filter:brightness(.98)}
  .btn-secondary{background:var(--roxo-cl);color:var(--roxo)}
  .btn-secondary:hover{filter:brightness(.97)}
  .btn-ghost{background:#fff;color:var(--roxo);border:1px solid #e9e1ff}

  /* Listas de detalhes (informa√ß√µes da festa) */
  .details-list{list-style:none;display:grid;grid-template-columns:1fr;gap:.55rem;justify-items:center;margin-top:2px}
  .details-item{display:flex;align-items:center;gap:.55rem;font-size:1rem;justify-content:center;text-align:center}
  .details-item .icon{display:inline-flex;align-items:center;justify-content:center;width:1.4em;height:1.4em;font-size:1.2rem;transform:translateY(1px);color:var(--roxo);}

  /* Bot√µes da Info da Festa: mesma propor√ß√£o dos demais */
  .info-actions{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
  .info-actions .btn{min-width:220px;padding:12px 18px}

  /* √Ålbum */
  .album-preview{display:grid;grid-template-columns: repeat(3,1fr);gap:10px;justify-items:center;margin:6px auto 12px}
  .album-preview .frame{position:relative;overflow:hidden;border-radius:12px;aspect-ratio:1/1;width:120px;box-shadow:0 4px 6px rgba(0,0,0,.1);transform:rotate(var(--tilt,0deg));transition:transform .5s ease;background:#f5f0ff}
  .album-preview .frame img{width:100%;height:100%;display:block;object-fit:cover;object-position:center}

  /* Mapa + Playlist + Tempo */
  .map-container{width:100%;height:300px;border-radius:12px;overflow:hidden}
  iframe{width:100%;height:100%;border:0}
  .playlist-iframe{width:100%;max-width:720px;height:250px;border-radius:12px;overflow:hidden;border:1px solid #eee;background:#fff;margin:0 auto}
  .weather-wrapper{display:flex;justify-content:center;margin:18px 0 28px}
  .weather-card{width:min(680px,92vw);padding:18px;border-radius:12px;background:var(--card-bg);backdrop-filter:blur(8px);box-shadow:var(--shadow);text-align:left}
  .weather-app{color:var(--roxo);font-weight:800;letter-spacing:-0.02em;}
  .weather-date{margin-top:6px;font-size:1rem;color:#666}
  .weather-text{margin:12px 0 6px;font-size:1rem;color:#4a4a4a}
  .weather-source{margin-top:8px;font-size:.92rem;color:#7a7a7a}
  .weather-source a{color:var(--roxo)}
  .weather-card h2{ text-align:left; margin-bottom:2px }

  /* Overlay de boas‚Äëvindas (tocar MP3) */
  .welcome-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
  .welcome-card{width:min(92vw,520px);background:#fff;border-radius:16px;padding:26px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.2)}
  .welcome-card h2{font-size:1.6rem;color:var(--roxo);margin-bottom:10px}
  .welcome-card p{color:#444;margin-bottom:16px}
  .welcome-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}

  /* Modal gen√©rico */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:9998}
  .modal{width:min(92vw,560px);background:#fff;border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25);position:relative}
  .modal h3{font-size:1.45rem;color:var(--roxo);font-weight:800;letter-spacing:-.02em;margin-bottom:8px;text-align:left}
  .modal .modal-sub{color:#555;margin-bottom:14px}
  .modal .field{margin:12px 0}
  .modal label{font-weight:700;color:#222;display:block;margin-bottom:6px}
  .modal input, .modal textarea, .modal select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #eadfff;background:#f9f6ff;outline:none}
  .modal input:focus,.modal textarea:focus{border-color:#d3c6ff;box-shadow:0 0 0 3px #efe9ff}
  .modal .modal-actions{display:flex;gap:12px;justify-content:flex-start;margin-top:14px}
  .modal-x{position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:28px;line-height:1;color:#9a8ad6;cursor:pointer}
  .modal .note{ font-size:.92rem; color:#666; margin-top:6px; }

  /* Altern√¢ncia SIM / N√ÉO pequenos */
  .yesno{display:flex;gap:8px}
  .yesno .btn{padding:10px 12px;font-size:.95rem;font-weight:700}

  /* Filhos (grid) */
  .kids-grid{display:grid;grid-template-columns:1fr 110px;gap:10px}
  .kid-age,.kid-name{width:100%}

  footer{padding:30px 0 70px;text-align:center;font-size:12px;color:#9a9a9a}

  /* Pequenos ajustes */
  .muted{text-align:center;color:#7d7d7d}

  @media (min-width:600px){
    .details-list{grid-template-columns:repeat(2,1fr)}
  }
  @media (min-width:900px){
    .details-list{grid-template-columns:repeat(3,1fr)}
  }

  /* Mural (rotator) */
  .mural-message{min-height:70px;display:flex;align-items:center;justify-content:center;padding:8px 10px;transition:opacity .6s ease;opacity:1;text-align:center}
  .mural-message.fade{opacity:0}
</style>
</head>
<body>

<!-- Tela de Boas‚Äëvindas para iniciar m√∫sica -->
<div class="welcome-overlay" id="welcome">
  <div class="welcome-card">
    <h2>Bem‚Äëvindo(a) √† Festa da Isabella! üé∂</h2>
    <p>Toque a m√∫sica para entrar no clima da celebra√ß√£o.</p>
    <div class="welcome-actions">
      <button class="btn btn-primary" id="start-music">Entrar e tocar playlist</button>
      <button class="btn btn-secondary" id="enter-silent">Entrar sem m√∫sica</button>
    </div>
  </div>
</div>

<!-- √ÅUDIO local (pr√©via) -->
<audio id="bg-audio" preload="auto">
  <source src="assets/kids-children-baby-music-363272.mp3" type="audio/mpeg">
</audio>

<header class="hero">
  <div class="hero-inner">
    <h1>Festa da Isabella</h1>
    <p>Celebrando seu 1¬∫ anivers√°rio</p>
  </div>
</header>

<main class="container">

  <!-- Boas‚Äëvindas (sempre primeiro) -->
  <section class="card">
    <h2>Boas‚Äëvindas</h2>
    <p class="lead">
      √â com muita alegria que convidamos voc√™ para celebrar o 1¬∫ anivers√°rio da nossa princesa Isabella! üéâüíñ
      Ser√° um momento especial para reunirmos fam√≠lia e amigos, com muita divers√£o, m√∫sica e boas lembran√ßas.
      Esperamos voc√™ para comemorar conosco esse dia t√£o importante! ü•≥‚ú®
    </p>
  </section>

  <!-- Mural -->
  <section class="card" id="mural-card">
    <h2>Mural üíå</h2>
    <div class="mural-message" id="muralMessage">Seja o primeiro a deixar um recado üíú</div>
    <div class="button-row">
      <button class="btn btn-primary" id="open-mural">Deixar mensagem üíå</button>
    </div>
  </section>

  <!-- Informa√ß√µes da festa -->
  <section class="card">
    <h2>Informa√ß√µes da festa</h2>
    <ul class="details-list">
      <li class="details-item"><span class="icon">üìÖ</span>22 de novembro de 2025, 14h00‚Äì18h00</li>
      <li class="details-item"><span class="icon">üìç</span>S√≠tio Verdes Encantos ‚Äì Estr Zumbi dos Palmares, 286 - Tingu√°, Nova Igua√ßu - RJ, 26063-355, Brasil</li>
      <li class="details-item"><span class="icon">üëó</span>Traje: casual festivo</li>
    </ul>
    <div class="info-actions">
      <button class="btn btn-primary" id="btn-confirmar">Confirmar presen√ßa</button>
      <a class="btn btn-secondary" href="festa_da_isabella.ics" download>Adicionar ao calend√°rio</a>
    </div>
  </section>

  <!-- √Ålbum -->
  <section class="card">
    <h2>√Ålbum de fotos</h2>
    <div class="album-preview">
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
    </div>
    <div class="button-row" style="margin-top:8px">
      <a class="btn btn-secondary" href="https://www.icloud.com/sharedalbum/#B2RJEsNWnGMlnHa" target="_blank" rel="noopener">Abrir √°lbum completo</a>
    </div>
  </section>

  <!-- Como chegar -->
  <section class="card">
    <h2>Como chegar</h2>
    <div class="map-container">
      <iframe
        src="https://maps.google.com/maps?q=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil&t=m&z=15&ie=UTF8&iwloc=&output=embed"
        allowfullscreen loading="lazy"></iframe>
    </div>
    <div class="button-row">
      <a class="btn btn-secondary"
        href="https://www.google.com/maps/dir/?api=1&destination=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil"
        target="_blank" rel="noopener">Tra√ßar rota</a>
      <a class="btn btn-secondary"
        href="https://www.google.com/maps/search/?api=1&query=S%C3%ADtio%20Verdes%20Encantos%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil"
        target="_blank" rel="noopener">Abrir no Google Maps</a>
    </div>
  </section>

  <!-- Sugest√£o de presentes -->
  <section class="card">
    <h2>Sugest√£o de presentes üíù</h2>
    <ul class="details-list">
      <li class="details-item"><span class="icon">üß∏</span>Brinquedos educativos</li>
      <li class="details-item"><span class="icon">üëó</span>Roupas tamanho 2 anos (cores suaves)</li>
      <li class="details-item"><span class="icon">ü©∞</span>Cal√ßados a partir do tamanho 22</li>
    </ul>
    <div class="button-row">
      <a class="btn btn-secondary" target="_blank" rel="noopener"
        href="https://wa.me/5521993835163?text=Oi%2C%20tenho%20uma%20d%C3%BAvida%20sobre%20o%20presente%20da%20Isabella">D√∫vidas sobre o presente</a>
    </div>
  </section>

  <!-- Playlist (Apple Music) -->
  <section class="card">
    <h2>Playlist da festa</h2>
    <div class="playlist-iframe">
      <iframe allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
              frameborder="0" height="100%" style="width:100%;overflow:hidden;background:transparent;"
              sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
              src="https://embed.music.apple.com/br/playlist/playlist-festa-da-isabella/pl.u-EdAVP4ECGZ0X3">
      </iframe>
    </div>
  </section>

  <!-- Tempo -->
  <section class="card">
    <div class="weather-wrapper">
      <div class="weather-card">
        <h2 class="weather-app">Tempo</h2>
        <div class="weather-date" id="weatherDate">‚Äî</div>
        <div class="weather-text" id="weatherText">Carregando‚Ä¶</div>
        <div class="weather-source" id="weatherSource">Fonte: ‚Äî</div>
      </div>
    </div>
  </section>
</main>

<footer>¬© 2025 Hugo Mattos. Todos os direitos reservados.</footer>

<!-- Modal: Mural (deixar mensagem) -->
<div class="modal-overlay" id="mural-modal" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mural-title">
    <button class="modal-x" id="mural-close" aria-label="Fechar">√ó</button>
    <h3 id="mural-title">Deixar mensagem üíå</h3>
    <p class="modal-sub">M√°x. 140 caracteres. Se quiser, assine no final (ex.: ‚Äú‚Äî Fam√≠lia Silva‚Äù).</p>

    <div class="field">
      <label for="mural-msg">Mensagem *</label>
      <textarea id="mural-msg" rows="3" maxlength="140" placeholder="Escreva sua mensagem"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary" id="mural-send">Publicar</button>
      <button class="btn btn-secondary" id="mural-cancel">Cancelar</button>
    </div>

    <div id="mural-error" class="note" style="display:none;margin-top:10px;color:#b3261e;">
      N√£o foi poss√≠vel publicar agora. Tente de novo.
    </div>
  </div>
</div>

<!-- Modal: Confirma√ß√£o de presen√ßa -->
<div class="modal-overlay" id="confirm-modal" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <button class="modal-x" id="confirm-close" aria-label="Fechar">√ó</button>
    <h3 id="confirm-title">Confirma√ß√£o de presen√ßa ‚ú®</h3>
    <p class="modal-sub">Preencha seus dados e envie ‚Äî abriremos o WhatsApp com a mensagem pronta.</p>

    <div class="field">
      <label for="name">Seu nome *</label>
      <input type="text" id="name" placeholder="Nome completo" required>
    </div>

    <div class="field">
      <label>Voc√™ vai?</label>
      <div class="yesno">
        <button type="button" class="btn btn-secondary" id="btn-no">N√£o</button>
        <button type="button" class="btn btn-secondary" id="btn-yes">Sim</button>
      </div>
    </div>

    <div id="extra-fields" hidden>
      <div class="field">
        <label for="acompanha">Acompanhante</label>
        <input type="text" id="acompanha" placeholder="Nome do(a) acompanhante (se houver)">
      </div>

      <div class="field">
        <label for="qtd">Qtd. filhos</label>
        <input type="number" id="qtd" min="0" value="0">
        <div class="note">Ao informar a quantidade, surgem os campos para nome e idade.</div>
      </div>

      <div id="children-wrap" class="field" hidden>
        <label>Filhos</label>
        <div id="children-grid" class="kids-grid"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary" id="confirm-send">Enviar</button>
      <button class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIGURA√á√ïES ====== */
const SUPABASE_URL = "https://kfoousycrqscvhivhmxu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtmb291c3ljcnFzY3ZoaXZobXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMDI1MTcsImV4cCI6MjA3MDY3ODUxN30.e55uMlW4mBmQjvG0U9WaEyqLPvjL9US3LP_9IvNTLVQ";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== √ÅLBUM (6 imagens rotativas) ====== */
const previewImages = [
  'album2/IMG_5139.jpeg','album2/IMG_5010.jpeg','album2/IMG_4772.jpeg',
  'album2/IMG_4765.jpeg','album2/IMG_4639.jpeg','album2/IMG_6911.jpeg',
  'album2/IMG_4450.jpeg','album2/IMG_4352.jpeg','album2/IMG_3056.jpeg',
  'album2/96f8947a-603d-43c7-b498-292922662164.jpeg'
];
function shuffle(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b;}
(function(){
  const frames = document.querySelectorAll('.album-preview .frame');
  function fillPreview(){
    const imgs = shuffle(previewImages);
    frames.forEach((frame, idx) => {
      const img = frame.querySelector('img');
      img.src = imgs[idx % imgs.length];
      const angle = (Math.random()*10 - 5);
      frame.style.setProperty('--tilt', angle + 'deg');
    });
  }
  fillPreview();
  setInterval(fillPreview, 8000);
})();

/* ====== BOAS-VINDAS / PLAY MP3 ====== */
(function(){
  const welcome = document.getElementById('welcome');
  const startBtn = document.getElementById('start-music');
  const enterSilent = document.getElementById('enter-silent');
  const audio = document.getElementById('bg-audio');
  function closeWelcome(){ welcome.style.display='none'; }
  startBtn?.addEventListener('click', async () => {
    try{ await audio.play(); }catch(e){ /* ignore */ }
    closeWelcome();
  });
  enterSilent?.addEventListener('click', () => { closeWelcome(); });
})();

/* ====== MURAL (listar + rotacionar + enviar) ====== */
(async function(){
  const txt = document.getElementById('muralMessage');
  const openBtn = document.getElementById('open-mural');
  const modal = document.getElementById('mural-modal');
  const closeX = document.getElementById('mural-close');
  const cancel = document.getElementById('mural-cancel');
  const send = document.getElementById('mural-send');
  const msgInput = document.getElementById('mural-msg');
  const errBox = document.getElementById('mural-error');

  function open(){ modal.hidden=false; setTimeout(()=>msgInput.focus(),50); }
  function close(){ modal.hidden=true; msgInput.value=''; errBox.style.display='none'; }

  openBtn?.addEventListener('click', open);
  closeX?.addEventListener('click', close);
  cancel?.addEventListener('click', close);
  modal?.addEventListener('click', (e)=>{ if(e.target===modal) close(); });

  async function fetchMessages(){
    const { data, error } = await supabaseClient
      .from('messages')
      .select('mensagem, created_at')
      .order('created_at', { ascending:false })
      .limit(20);
    if(error){ return []; }
    return data?.map(d => d.mensagem).filter(Boolean) ?? [];
  }

  let pool = await fetchMessages();
  if(!pool.length){
    pool = [
      "Ansiosos para comemorar com voc√™s! üéâ",
      "Que Deus aben√ßoe esse dia especial! ‚ú®",
      "Isabella, muita sa√∫de e amor! üíú",
      "J√° contando os dias! ü•≥"
    ];
  }

  let i = 0;
  function rotate(){
    if(!pool.length) return;
    txt.classList.add('fade');
    setTimeout(()=>{
      txt.textContent = pool[i % pool.length];
      txt.classList.remove('fade');
      i++;
    }, 350);
  }
  rotate();
  setInterval(rotate, 4200);

  // Realtime: sempre que inserir, atualiza pool
  try{
    supabaseClient
      .channel('msg-realtime')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, async (payload)=>{
        pool.unshift(payload.new.mensagem);
      }).subscribe();
  }catch(e){/* opcional */}

  // Enviar
  send?.addEventListener('click', async ()=>{
    const v = (msgInput.value||'').trim();
    if(!v){ msgInput.focus(); return; }
    errBox.style.display='none';
    const { error } = await supabaseClient.from('messages').insert({ mensagem: v });
    if(error){ errBox.style.display='block'; return; }
    close();
  });
})();

/* ======= CONFIRMA√á√ÉO (WhatsApp) ======= */
(function(){
  const modal = document.getElementById('confirm-modal');
  const openBtn = document.getElementById('btn-confirmar');
  const closeBtn = document.getElementById('confirm-close');
  const cancelBtn = document.getElementById('confirm-cancel');
  const sendBtn = document.getElementById('confirm-send');

  const nameEl = document.getElementById('name');
  const acompEl = document.getElementById('acompanha');
  const qtdEl = document.getElementById('qtd');
  const wrapExtra = document.getElementById('extra-fields');

  const wrapChildren = document.getElementById('children-wrap');
  const gridChildren = document.getElementById('children-grid');

  const btnYes = document.getElementById('btn-yes');
  const btnNo  = document.getElementById('btn-no');

  let vai = null;

  function open(){ modal.hidden = false; setTimeout(()=>nameEl.focus(), 50); }
  function close(){ modal.hidden = true; }

  openBtn?.addEventListener('click', open);
  closeBtn?.addEventListener('click', close);
  cancelBtn?.addEventListener('click', close);
  modal?.addEventListener('click', (ev)=>{ if(ev.target === modal) close(); });

  function highlight(btn, active){
    btn.classList.toggle('btn-primary', active);
    btn.classList.toggle('btn-secondary', !active);
  }
  function setVai(value){
    vai = value;
    highlight(btnYes, value === true);
    highlight(btnNo,  value === false);
    wrapExtra.hidden = (value !== true);
    if(value !== true){
      acompEl.value = '';
      qtdEl.value = 0;
      gridChildren.innerHTML = '';
      wrapChildren.hidden = true;
    }
  }
  highlight(btnYes, false); highlight(btnNo, false);
  btnYes.addEventListener('click', ()=>setVai(true));
  btnNo .addEventListener('click', ()=>setVai(false));

  function rebuildChildren(){
    const n = Math.max(0, parseInt(qtdEl.value || '0', 10));
    gridChildren.innerHTML = '';
    wrapChildren.hidden = (n === 0);
    for(let i=0;i<n;i++){
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.placeholder = `Nome do filho ${i+1}`;
      nameInput.className = 'kid-name';

      const ageInput = document.createElement('input');
      ageInput.type = 'number';
      ageInput.min = '0';
      ageInput.placeholder = 'Idade';
      ageInput.className = 'kid-age';

      gridChildren.appendChild(nameInput);
      gridChildren.appendChild(ageInput);
    }
  }
  qtdEl.addEventListener('input', rebuildChildren);

  // Enviar para WhatsApp
  sendBtn.addEventListener('click', ()=>{
    const nome = (nameEl.value||'').trim();
    if(!nome){ nameEl.focus(); return; }
    if(vai === null){ btnYes.focus(); return; }

    let msg = `Ol√°! Confirmo minha presen√ßa no anivers√°rio da Isabella.%0A`;
    msg += `Nome: ${encodeURIComponent(nome)}%0A`;
    msg += `Vou: ${vai ? 'Sim' : 'N√£o'}%0A`;

    if(vai){
      const acomp = (acompEl.value||'').trim();
      if(acomp){ msg += `Acompanhante: ${encodeURIComponent(acomp)}%0A`; }

      const n = Math.max(0, parseInt(qtdEl.value||'0',10));
      msg += `Filhos: ${n}%0A`;
      if(n>0){
        const pairs = [];
        const inputs = gridChildren.querySelectorAll('input');
        for(let i=0;i<inputs.length;i+=2){
          const nomeF = (inputs[i].value||'').trim();
          const idade = (inputs[i+1].value||'').trim();
          if(nomeF || idade){
            pairs.push(`${nomeF || '‚Äî'} (${idade || '?'})`);
          }
        }
        if(pairs.length){ msg += `Detalhes: ${encodeURIComponent(pairs.join(', '))}%0A`; }
      }
    }

    const phone = '5521993835163';
    const href = `https://wa.me/${phone}?text=${msg}`;
    window.open(href, '_blank','noopener');
    close();
  });
})();

/* ====== TEMPO ====== */
(function(){
  const EVENT_DATE_DEFAULT = '2025-11-22';
  const LAT = -22.606, LON = -43.490;
  const TZ = 'America/Sao_Paulo';
  const qs = new URLSearchParams(location.search);
  const EVENT_DATE = qs.get('data') || EVENT_DATE_DEFAULT;

  function formatPtBRDate(iso){
    const d = new Date(iso + 'T12:00:00');
    return new Intl.DateTimeFormat('pt-BR',{ day:'2-digit', month:'long'}).format(d);
  }
  document.getElementById('weatherDate').textContent = formatPtBRDate(EVENT_DATE);

  function daysTo(dateIso){
    const today = new Date(); today.setHours(0,0,0,0);
    const ev = new Date(dateIso+'T00:00:00');
    return Math.round((ev - today)/86400000);
  }
  const dleft = daysTo(EVENT_DATE);
  const elText = document.getElementById('weatherText');
  const elSource = document.getElementById('weatherSource');

  function setSourceStamp(sourceName){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('pt-BR', {
      day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit',
      timeZone: TZ
    }).format(now).replace('.', '');
    elSource.innerHTML = `Fonte: <a href="https://open-meteo.com/" target="_blank" rel="noopener">${sourceName}</a> ‚Ä¢ Atualizado em ${fmt} (BRT)`;
  }

  async function getDailyForecast(){
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = new URLSearchParams({
      latitude: LAT, longitude: LON, timezone: TZ,
      daily: 'temperature_2m_max,temperature_2m_min,precipitation_probability_mean',
      start_date: EVENT_DATE, end_date: EVENT_DATE
    });
    const r = await fetch(url); if(!r.ok) throw new Error('forecast http');
    return r.json();
  }
  async function getClimateNormals(month){
    const url = new URL('https://climate-api.open-meteo.com/v1/climate');
    url.search = new URLSearchParams({
      latitude: LAT, longitude: LON,
      start_year: 1991, end_year: 2020, models: 'ERA5',
      monthly: 'temperature_2m_max_mean,temperature_2m_min_mean,precipitation_probability_mean',
      month: month
    });
    const r = await fetch(url); if(!r.ok) throw new Error('climate http');
    return r.json();
  }

  (async () => {
    try{
      if(dleft >= 0 && dleft <= 16){
        const data = await getDailyForecast();
        const d = data.daily;
        const tmax = Math.round(d.temperature_2m_max[0]);
        const tmin = Math.round(d.temperature_2m_min[0]);
        const ppop = d.precipitation_probability_mean?.[0];
        elText.textContent =
          (typeof ppop === 'number')
          ? `Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞, chance de chuva ${ppop}%`
          : `Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞`;
        setSourceStamp('Open‚ÄëMeteo (previs√£o di√°ria)');
      }else{
        const month = Number(EVENT_DATE.split('-')[1]);
        const clim = await getClimateNormals(month);
        const m = clim.monthly || clim.daily || {};
        const tmax = Math.round(m.temperature_2m_max_mean?.[0] ?? 27);
        const tmin = Math.round(m.temperature_2m_min_mean?.[0] ?? 20);
        elText.textContent = `Nesta √©poca do ano, a temperatura costuma variar entre ${tmin}¬∞ e ${tmax}¬∞.`;
        setSourceStamp('Open‚ÄëMeteo (climatologia 1991‚Äì2020)');
      }
    }catch(e){
      elText.textContent = 'Nesta √©poca do ano, a temperatura costuma variar entre 20¬∞ e 27¬∞.';
      setSourceStamp('Open‚ÄëMeteo');
    }
  })();
})();
</script>
</body>
</html>
