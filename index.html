<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Festa da Isabella</title>
<style>
  :root{
    --roxo:#5b3fa2;
    --roxo-esc:#493183;
    --roxo-10:#efe8ff;
    --bg:#f7f7fb;
    --card:#ffffff;
    --txt:#333;
    --muted:#6b7280;
    --ok:#12b886;
    --danger:#ef4444;
    --radius:14px;
    --shadow:0 8px 24px rgba(0,0,0,.08);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
    line-height:1.55;background:var(--bg);color:var(--txt);
  }
  a{color:var(--roxo);text-decoration:none}
  .container{max-width:960px;margin:0 auto;padding:20px}

  /* Hero */
  .hero{
    position:relative;background:url('hero.jpg') center/cover no-repeat;
    height:56vh; min-height:320px; display:flex; align-items:center; justify-content:center; color:#fff; text-align:center;
  }
  .hero::before{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.35),rgba(0,0,0,.25))}
  .hero-inner{position:relative;padding:8px 16px}
  .hero h1{font-size:clamp(2rem,1.2rem + 2.6vw,3rem);font-weight:800;letter-spacing:-.02em}
  .hero p{opacity:.95;margin-top:.25rem}

  /* Cards */
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:22px; margin:18px 0; text-align:center;
  }
  .card h2{
    color:var(--roxo); font-size:clamp(1.35rem,1.1rem + .9vw,1.9rem);
    font-weight:800; letter-spacing:-.02em; margin-bottom:10px;
  }
  .card p{color:#444;max-width:66ch;margin:0 auto}
  .muted{color:var(--muted)}

  /* Listas de detalhes */
  .details-list{list-style:none;display:grid;grid-template-columns:1fr;gap:.6rem;justify-items:center;margin:10px 0 6px}
  .details-item{display:flex;align-items:center;gap:.6rem;justify-content:center}
  .details-item .icon{transform:translateY(1px)}

  /* Grade de bot√µes */
  .btn-row{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:14px}
  .btn{
    --h:44px;
    display:inline-flex;align-items:center;justify-content:center;
    padding:0 18px;height:var(--h);border:none;border-radius:10px;
    font-weight:700;cursor:pointer;transition:.18s ease;white-space:nowrap;
  }
  .btn-primary{background:var(--roxo);color:#fff}
  .btn-primary:hover{background:var(--roxo-esc)}
  .btn-secondary{background:var(--roxo-10);color:var(--roxo)}
  .btn-secondary:hover{filter:brightness(.98)}
  .btn-ghost{background:#fff;color:var(--txt);border:1px solid #e7e7ee}
  .btn-danger{background:var(--danger);color:#fff}

  /* Inputs */
  .form{display:grid;gap:10px;margin-top:10px}
  .field{display:grid;gap:6px;text-align:left}
  .label{font-weight:700}
  .control{
    height:44px;border-radius:10px;border:1px solid #e7e7ee;padding:0 14px;background:#fafafe;
    outline:none;transition:border .15s ease;
  }
  .control:focus{border-color:#c7b6ff;box-shadow:0 0 0 3px rgba(91,63,162,.12)}
  .textarea{height:auto;min-height:96px;padding:12px 14px;resize:vertical}

  /* √Ålbum */
  .album-preview{display:grid;grid-template-columns: repeat(3,1fr);gap:10px;justify-items:center;margin:2px auto 8px}
  .frame{position:relative;overflow:hidden;border-radius:12px;aspect-ratio:1/1;width:118px;box-shadow:0 4px 10px rgba(0,0,0,.08);transform:rotate(var(--t,0deg));transition:transform .5s}
  .frame img{width:100%;height:100%;object-fit:cover}

  /* Mapa/Playlist */
  .map{width:100%;height:300px;border-radius:12px;overflow:hidden}
  .playlist-iframe{width:100%;height:210px;border:0;border-radius:12px}

  /* Tempo */
  .weather{padding:18px;text-align:left}
  .weather h3{color:var(--roxo);font-size:1.35rem;margin-bottom:8px}
  .weather .src{font-size:.95rem;color:var(--muted);margin-top:8px}

  /* Modals (Boas‚Äëvindas, Mural, Presen√ßa) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay.show{display:flex}
  .modal{
    width:min(92vw,560px);background:#fff;border-radius:16px;box-shadow:var(--shadow);
    padding:22px; text-align:left; position:relative;
  }
  .modal h3{color:var(--roxo);font-size:clamp(1.35rem,1.1rem + .9vw,1.9rem);font-weight:800;letter-spacing:-.02em;margin-bottom:8px}
  .modal .x{position:absolute;right:14px;top:12px;border:0;background:transparent;font-size:24px;line-height:1;cursor:pointer;color:#9aa}
  .choice{display:flex;gap:10px}
  .choice .chip{
    flex:1;display:flex;align-items:center;justify-content:center;height:44px;border-radius:10px;border:1px solid #e7e7ee;background:#f5f2ff;color:var(--roxo);font-weight:700;cursor:pointer;
  }
  .choice .chip.active{background:var(--roxo);color:#fff;border-color:var(--roxo)}

  /* Mural ‚Äì carrossel */
  .mural-slot{min-height:64px;display:flex;align-items:center;justify-content:center}
  .mural-msg{opacity:0;transform:translateY(6px);transition:opacity .45s ease, transform .45s ease}
  .mural-msg.show{opacity:1;transform:translateY(0)}

  /* Ajustes responsivos */
  @media (min-width:560px){
    .btn{--h:46px}
    .dual{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  }

  footer{padding:32px 0;text-align:center;color:#9aa}
</style>
</head>
<body>

<!-- Overlay Boas‚Äëvindas (tocar MP3) -->
<div class="overlay" id="welcomeOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <button class="x" id="welcomeClose" aria-label="Fechar">√ó</button>
    <h3 id="welcomeTitle">Bem‚Äëvindo(a) √† Festa da Isabella! üé∂</h3>
    <p class="muted" style="margin-bottom:14px">Toque a m√∫sica para entrar no clima da celebra√ß√£o.</p>
    <div class="btn-row">
      <button class="btn btn-primary" id="btnPlayWelcome">Entrar e tocar playlist</button>
      <button class="btn btn-secondary" id="btnEnterSilent">Entrar sem m√∫sica</button>
    </div>
  </div>
</div>

<!-- Overlay Mural (enviar mensagem) -->
<div class="overlay" id="muralOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="muralTitle">
    <button class="x" id="muralClose" aria-label="Fechar">√ó</button>
    <h3 id="muralTitle">Deixar mensagem üíå</h3>
    <p class="muted">M√°x. 140 caracteres. Se quiser, assine no final (ex.: ‚Äú‚Äî Fam√≠lia Silva‚Äù).</p>
    <div class="form" style="margin-top:12px">
      <div class="field">
        <label class="label" for="muralText">Mensagem *</label>
        <textarea id="muralText" class="control textarea" maxlength="140" placeholder="Ex.: Ansiosos para comemorar com voc√™s! üéâ"></textarea>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="muralSend">Publicar</button>
        <button class="btn btn-secondary" id="muralCancel">Cancelar</button>
      </div>
      <div class="muted" id="muralHint" style="min-height:22px"></div>
    </div>
  </div>
</div>

<!-- Overlay Confirma√ß√£o de presen√ßa (abre s√≥ ao clicar no bot√£o do card) -->
<div class="overlay" id="rsvpOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rsvpTitle">
    <button class="x" id="rsvpClose" aria-label="Fechar">√ó</button>
    <h3 id="rsvpTitle">Confirma√ß√£o de presen√ßa ‚ú®</h3>
    <p class="muted" style="margin-bottom:8px">Preencha seus dados e envie ‚Äî abriremos o WhatsApp com a mensagem pronta.</p>

    <div class="form">
      <div class="field">
        <label class="label" for="rsvpNome">Seu nome *</label>
        <input id="rsvpNome" class="control" placeholder="Nome completo" />
      </div>

      <div class="field">
        <label class="label">Voc√™ vai?</label>
        <div class="choice" id="rsvpChoice">
          <button type="button" class="chip" data-val="nao">N√£o</button>
          <button type="button" class="chip active" data-val="sim">Sim</button>
        </div>
      </div>

      <div class="field">
        <label class="label" for="rsvpAcomp">Acompanhante</label>
        <input id="rsvpAcomp" class="control" placeholder="Nome do(a) acompanhante (se houver)" />
      </div>

      <div class="dual">
        <div class="field">
          <label class="label" for="rsvpQtd">Qtd. filhos</label>
          <input id="rsvpQtd" class="control" type="number" min="0" value="0" />
        </div>
        <div class="field">
          <label class="label" for="rsvpIdades">Idades dos filhos</label>
          <input id="rsvpIdades" class="control" placeholder="Ex.: 5, 2" />
        </div>
      </div>

      <div class="btn-row" style="margin-top:6px">
        <button class="btn btn-primary" id="rsvpSend">Enviar</button>
        <button class="btn btn-secondary" id="rsvpCancel">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<header class="hero">
  <div class="hero-inner">
    <h1>Festa da Isabella</h1>
    <p>Celebrando seu 1¬∫ anivers√°rio</p>
  </div>
</header>

<main class="container">

  <!-- Boas‚Äëvindas (primeiro card) -->
  <section class="card" id="boasvindas">
    <h2>Boas‚Äëvindas</h2>
    <p>
      √â com muita alegria que convidamos voc√™ para celebrar o 1¬∫ anivers√°rio da nossa princesa Isabella! üéâüíñ<br>
      Ser√° um momento especial para reunirmos fam√≠lia e amigos, com muita divers√£o, m√∫sica e boas lembran√ßas.<br>
      Esperamos voc√™ para comemorar conosco esse dia t√£o importante! ü•≥‚ú®
    </p>
  </section>

  <!-- Mural -->
  <section class="card" id="cardMural">
    <h2>Mural üíå</h2>
    <div class="mural-slot" id="muralSlot">
      <div class="muted" id="muralEmpty">Seja o primeiro a deixar um recado üíú</div>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="openMural">Deixar mensagem üíå</button>
    </div>
  </section>

  <!-- Informa√ß√µes -->
  <section class="card" id="infos">
    <h2>Informa√ß√µes da festa</h2>
    <ul class="details-list">
      <li class="details-item"><span class="icon">üìÖ</span>22 de novembro de 2025, 14h00‚Äì18h00</li>
      <li class="details-item">
        <span class="icon">üìç</span>
        S√≠tio Verdes Encantos ‚Äì Estr Zumbi dos Palmares, 286 - Tingu√°, Nova Igua√ßu - RJ, 26063-355, Brasil
      </li>
      <li class="details-item"><span class="icon">üëó</span>Traje: casual festivo</li>
    </ul>
    <div class="btn-row">
      <button class="btn btn-primary" id="openRSVP">Confirmar presen√ßa</button>
      <a class="btn btn-secondary" href="festa_da_isabella.ics" download>Adicionar ao calend√°rio</a>
    </div>
  </section>

  <!-- √Ålbum -->
  <section class="card">
    <h2>√Ålbum de fotos</h2>
    <div class="album-preview" id="album">
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
    </div>
    <div class="btn-row">
      <a class="btn btn-secondary" href="https://www.icloud.com/sharedalbum/#B2RJEsNWnGMlnHa" target="_blank" rel="noopener">Abrir √°lbum completo</a>
    </div>
  </section>

  <!-- Como chegar -->
  <section class="card">
    <h2>Como chegar</h2>
    <div class="map">
      <iframe
        src="https://maps.google.com/maps?q=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil&t=m&z=15&ie=UTF8&iwloc=&output=embed"
        loading="lazy" allowfullscreen></iframe>
    </div>
    <div class="btn-row">
      <a class="btn btn-secondary"
         href="https://www.google.com/maps/dir/?api=1&destination=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil"
         target="_blank" rel="noopener">Tra√ßar rota</a>
      <a class="btn btn-secondary"
         href="https://www.google.com/maps/search/?api=1&query=S%C3%ADtio%20Verdes%20Encantos%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil"
         target="_blank" rel="noopener">Abrir no Google Maps</a>
    </div>
  </section>

  <!-- Presentes -->
  <section class="card">
    <h2>Sugest√£o de presentes üíù</h2>
    <ul class="details-list">
      <li class="details-item"><span class="icon">üß∏</span>Brinquedos educativos</li>
      <li class="details-item"><span class="icon">üëó</span>Roupas tamanho 2 anos (cores suaves)</li>
      <li class="details-item"><span class="icon">ü©∞</span>Cal√ßados a partir do tamanho 22</li>
    </ul>
    <div class="btn-row">
      <a class="btn btn-secondary" target="_blank" rel="noopener"
         href="https://wa.me/5521993835163?text=Oi%2C%20tenho%20uma%20d%C3%BAvida%20sobre%20o%20presente%20da%20Isabella">
        D√∫vidas sobre o presente
      </a>
    </div>
  </section>

  <!-- Playlist (Apple Music ‚Äì embed) -->
  <section class="card">
    <h2>Playlist da festa</h2>
    <iframe class="playlist-iframe"
            allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write *"
            sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation"
            src="https://embed.music.apple.com/br/playlist/playlist-festa-da-isabella/pl.u-76oNNkYtqByeMy"></iframe>
  </section>

  <!-- Tempo -->
  <section class="card weather" id="tempo">
    <h2>Tempo</h2>
    <div id="wDate" class="muted">22 de novembro</div>
    <p id="wText" style="margin-top:10px">Carregando‚Ä¶</p>
    <div class="src" id="wSrc">Fonte: ‚Äî</div>
  </section>
</main>

<footer>¬© 2025 Hugo Mattos. Todos os direitos reservados.</footer>

<!-- √Åudio local escondido para a abertura -->
<audio id="bgAudio" preload="auto">
  <source src="assets/kids-children-baby-music-363272.mp3" type="audio/mpeg">
</audio>

<!-- Supabase (ESM) -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  /* === CONFIG SUPABASE (seus dados) === */
  const SUPABASE_URL = 'https://kfoousycrqscvhivhmxu.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtmb291c3ljcnFzY3ZoaXZobXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMDI1MTcsImV4cCI6MjA3MDY3ODUxN30.e55uMlW4mBmQjvG0U9WaEyqLPvjL9US3LP_9IvNTLVQ';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* === UTIL === */
  const qs = s => document.querySelector(s);
  const qsa = s => document.querySelectorAll(s);

  /* === BOAS‚ÄëVINDAS / √ÅUDIO LOCAL === */
  const welcomeOverlay = qs('#welcomeOverlay');
  const bgAudio = qs('#bgAudio');
  const btnPlayWelcome = qs('#btnPlayWelcome');
  const btnEnterSilent = qs('#btnEnterSilent');
  const welcomeClose = qs('#welcomeClose');

  function openWelcome(){ welcomeOverlay.classList.add('show'); }
  function closeWelcome(){ welcomeOverlay.classList.remove('show'); }
  // mostrar s√≥ na primeira visita da sess√£o
  if(!sessionStorage.getItem('welcomed')) openWelcome();
  btnPlayWelcome.addEventListener('click', async () => {
    try{ await bgAudio.play(); }catch(e){ /* ignora bloqueio do navegador */ }
    sessionStorage.setItem('welcomed','1'); closeWelcome();
  });
  btnEnterSilent.addEventListener('click', () => { sessionStorage.setItem('welcomed','1'); closeWelcome(); });
  welcomeClose.addEventListener('click', closeWelcome);

  /* === √ÅLBUM (preencher e girar) === */
  const albumImgs = [
    'album2/IMG_5139.jpeg','album2/IMG_5010.jpeg','album2/IMG_4772.jpeg',
    'album2/IMG_4765.jpeg','album2/IMG_4639.jpeg','album2/IMG_6911.jpeg',
    'album2/IMG_4450.jpeg','album2/IMG_4352.jpeg','album2/IMG_3056.jpeg',
    'album2/96f8947a-603d-43c7-b498-292922662164.jpeg'
  ];
  function shuffle(a){const b=a.slice();for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b;}
  const frames = qsa('.frame img');
  function fillAlbum(){
    const imgs = shuffle(albumImgs);
    frames.forEach((img,i) => {
      img.src = imgs[i % imgs.length];
      img.parentElement.style.setProperty('--t', (Math.random()*8-4)+'deg');
    });
  }
  fillAlbum(); setInterval(fillAlbum, 8000);

  /* === MURAL === */
  const muralOverlay = qs('#muralOverlay');
  const muralClose = qs('#muralClose');
  const openMuralBtn = qs('#openMural');
  const muralText = qs('#muralText');
  const muralSend = qs('#muralSend');
  const muralCancel = qs('#muralCancel');
  const muralSlot = qs('#muralSlot');
  const muralEmpty = qs('#muralEmpty');
  const muralHint = qs('#muralHint');

  function openMural(){ muralOverlay.classList.add('show'); muralText.focus(); }
  function closeMural(){ muralOverlay.classList.remove('show'); muralText.value=''; muralHint.textContent=''; }
  openMuralBtn.addEventListener('click', openMural);
  muralCancel.addEventListener('click', closeMural);
  muralClose.addEventListener('click', closeMural);

  // carrossel suave
  let messages = [];
  let idx = 0;
  function renderMessage(text){
    muralEmpty?.remove();
    let el = qs('.mural-msg');
    if(!el){ el = document.createElement('div'); el.className='mural-msg'; muralSlot.appendChild(el); }
    // transi√ß√£o
    el.classList.remove('show');
    setTimeout(()=>{ el.textContent = text; el.classList.add('show'); }, 60);
  }
  async function loadMessages(){
    const { data, error } = await supabase
      .from('messages')
      .select('mensagem, created_at')
      .order('created_at', { ascending:false })
      .limit(25);
    if(!error && Array.isArray(data)){
      messages = data.map(d => d.mensagem).filter(Boolean);
      if(messages.length){ idx = 0; renderMessage(messages[0]); }
    }
  }
  function startCarousel(){
    setInterval(() => {
      if(messages.length){
        idx = (idx+1) % messages.length;
        renderMessage(messages[idx]);
      }
    }, 5000);
  }
  // realtime (se habilitado no projeto)
  try{
    supabase
      .channel('messages-feed')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, (payload)=>{
        const msg = payload?.new?.mensagem; if(!msg) return;
        messages.unshift(msg);
        renderMessage(msg);
      }).subscribe();
  }catch(_){/* ok sem realtime */}

  muralSend.addEventListener('click', async ()=>{
    const text = (muralText.value || '').trim();
    if(text.length < 3){ muralHint.textContent = 'Escreva pelo menos 3 caracteres.'; return; }
    muralHint.textContent = 'Publicando‚Ä¶';
    const { error } = await supabase.from('messages').insert({ mensagem:text });
    if(error){ muralHint.textContent = 'N√£o foi poss√≠vel publicar agora. Tente de novo.'; return; }
    muralHint.textContent = 'Publicado! Obrigado üíú';
    setTimeout(closeMural, 500);
  });

  await loadMessages(); startCarousel();

  /* === RSVP (WhatsApp) === */
  const rsvpOverlay = qs('#rsvpOverlay');
  const rsvpClose = qs('#rsvpClose');
  const openRSVP = qs('#openRSVP');
  const rsvpCancel = qs('#rsvpCancel');
  const rsvpSend = qs('#rsvpSend');
  const rsvpNome = qs('#rsvpNome');
  const rsvpAcomp = qs('#rsvpAcomp');
  const rsvpQtd = qs('#rsvpQtd');
  const rsvpIdades = qs('#rsvpIdades');
  const rsvpChoice = qs('#rsvpChoice');
  let rsvpVai = 'sim';

  openRSVP.addEventListener('click', ()=>{ rsvpOverlay.classList.add('show'); rsvpNome.focus(); });
  rsvpCancel.addEventListener('click', ()=> rsvpOverlay.classList.remove('show'));
  rsvpClose.addEventListener('click', ()=> rsvpOverlay.classList.remove('show'));

  rsvpChoice.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if(!chip) return;
    qsa('#rsvpChoice .chip').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    rsvpVai = chip.dataset.val;
  });

  rsvpSend.addEventListener('click', ()=>{
    const nome = (rsvpNome.value||'').trim();
    if(nome.length < 2){ rsvpNome.focus(); return; }
    const acomp = (rsvpAcomp.value||'').trim();
    const qtd = parseInt(rsvpQtd.value||'0',10) || 0;
    const idades = (rsvpIdades.value||'').trim();

    const vaiTxt = rsvpVai === 'sim' ? 'Sim' : 'N√£o';
    let msg = `Ol√°! Confirmo presen√ßa para o anivers√°rio da Isabella.%0A%0A` +
              `‚Ä¢ Nome: ${encodeURIComponent(nome)}%0A` +
              `‚Ä¢ Vai? ${vaiTxt}`;
    if(acomp) msg += `%0A‚Ä¢ Acompanhante: ${encodeURIComponent(acomp)}`;
    msg += `%0A‚Ä¢ Filhos: ${qtd}`;
    if(qtd>0 && idades) msg += `%0A‚Ä¢ Idades: ${encodeURIComponent(idades)}`;

    const url = `https://wa.me/5521993835163?text=${msg}`;
    window.open(url, '_blank', 'noopener');
    rsvpOverlay.classList.remove('show');
  });

  /* === TEMPO (Open‚ÄëMeteo) === */
  const EVENT_DATE = '2025-11-22';
  const LAT=-22.606, LON=-43.490, TZ='America/Sao_Paulo';
  function fmtDateBR(iso){const d=new Date(iso+'T12:00:00');return new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'long'}).format(d);}
  qs('#wDate').textContent = fmtDateBR(EVENT_DATE);
  async function getClimate(){
    const url = new URL('https://climate-api.open-meteo.com/v1/climate');
    url.search = new URLSearchParams({
      latitude:LAT, longitude:LON, start_year:1991, end_year:2020, models:'ERA5',
      monthly:'temperature_2m_max_mean,temperature_2m_min_mean,precipitation_probability_mean',
      month: Number(EVENT_DATE.split('-')[1])
    });
    const r = await fetch(url); return r.json();
  }
  async function getDaily(){
    const url = new URL('https://api.open-meteo.com/v1/forecast');
    url.search = new URLSearchParams({
      latitude:LAT, longitude:LON, timezone:TZ,
      daily:'temperature_2m_max,temperature_2m_min,precipitation_probability_mean',
      start_date:EVENT_DATE, end_date:EVENT_DATE
    });
    const r = await fetch(url); return r.json();
  }
  function daysTo(d){const t=new Date();t.setHours(0,0,0,0);const e=new Date(d+'T00:00:00');return Math.round((e-t)/86400000)}
  (async ()=>{
    const dleft = daysTo(EVENT_DATE);
    const wText=qs('#wText'), wSrc=qs('#wSrc');
    try{
      if(dleft>=0 && dleft<=16){
        const data = await getDaily();
        const d = data.daily;
        const tmax=Math.round(d.temperature_2m_max[0]), tmin=Math.round(d.temperature_2m_min[0]);
        const p=d.precipitation_probability_mean?.[0];
        wText.textContent = typeof p==='number'
          ? `Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞, chance de chuva ${p}%`
          : `Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞.`;
        const now = new Date();
        const stamp = new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',timeZone:TZ}).format(now).replace('.','');
        wSrc.innerHTML=`Fonte: Open‚ÄëMeteo (previs√£o di√°ria) ‚Ä¢ Atualizado em ${stamp} (BRT)`;
      }else{
        const clim = await getClimate();
        const m = clim.monthly || {};
        const tmax=Math.round(m.temperature_2m_max_mean?.[0] ?? 27);
        const tmin=Math.round(m.temperature_2m_min_mean?.[0] ?? 20);
        wText.textContent = `Nesta √©poca do ano, a temperatura costuma variar entre ${tmin}¬∞ e ${tmax}¬∞.`;
        const now = new Date();
        const stamp = new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',timeZone:TZ}).format(now).replace('.','');
        wSrc.innerHTML=`Fonte: Open‚ÄëMeteo (climatologia 1991‚Äì2020) ‚Ä¢ Atualizado em ${stamp} (BRT)`;
      }
    }catch(e){
      wText.textContent='Nesta √©poca do ano, a temperatura costuma variar entre 20¬∞ e 27¬∞.';
      wSrc.textContent='Fonte: Open‚ÄëMeteo';
    }
  })();
</script>
</body>
</html>
