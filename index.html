<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Festa da Isabella</title>
<meta name="theme-color" content="#5b3fa2"/>
<style>
  :root{
    --roxo:#5b3fa2;--roxo-esc:#493183;--roxo-cl:#efe8ff;
    --bg:#f7f7fb;--txt:#262626;--muted:#6b7280;--white:#fff;
    --shadow:0 10px 25px rgba(17,17,17,.08);
    --radius:14px;
    --p:0;
    --zoom: calc(8% * (1 - var(--p)));
  }
  *{box-sizing:border-box} html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;color:var(--txt);line-height:1.55;background:var(--bg)}
  a{color:var(--roxo);text-decoration:none}
  .container{max-width:980px;margin:0 auto;padding:22px 16px}

  /* ===== Fundo cont√≠nuo 100% DESFOCADO atr√°s dos cards ===== */
  .page-bg{
    position:fixed; inset:0; z-index:-2;
    background:url('hero.jpg') center/cover no-repeat;
    background-size: calc(100% + var(--zoom)) auto;
    filter: blur(20px) saturate(105%);
    transform: scale(1.05);
  }
  .page-bg::after{
    content:""; position:absolute; inset:0;
    background:linear-gradient(to bottom,
      rgba(247,247,251,0) 0%,
      rgba(247,247,251,.65) 40vh,
      rgba(247,247,251,1) 65vh);
  }

  /* ===== Hero ===== */
  .hero{
    height:58vh; min-height:340px; position:relative; overflow:hidden;
    display:flex; align-items:flex-end; justify-content:center; text-align:center;
    background:url('hero.jpg') center/cover no-repeat;
    background-size: calc(100% + var(--zoom)) auto;
  }
  .hero::before{
    content:""; position:absolute; inset:0;
    background:linear-gradient(to top,rgba(0,0,0,.55),rgba(0,0,0,.12));
    pointer-events:none;
  }
  .hero-inner{position:relative;width:100%;height:100%;display:flex;align-items:flex-end;justify-content:center}
  .hero-glow{
    position:absolute; left:0; right:0; bottom:0; height:40%;
    background:linear-gradient(to bottom, rgba(255,255,255,0) 0%,
                                          rgba(255,255,255,.25) 35%,
                                          rgba(247,247,251,1) 100%);
    backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    opacity: calc(.6 + .4 * var(--p));
    pointer-events:none;
  }
  .hero-title{position:relative; z-index:1; padding-bottom:22px;
    transform: translateY(calc(12px * (1 - var(--p))));
    transition: transform .2s ease-out;
  }
  .hero h1{
    color:#fff; margin:0 0 6px;
    font-size:clamp(36px,6vw,56px); font-weight:800; letter-spacing:-.02em;
    text-shadow:0 6px 20px rgba(0,0,0,.45);
  }
  .hero p{
    color:#fff; margin:0 0 24px; font-weight:500; font-size:clamp(16px,2.3vw,20px);
    text-shadow:0 4px 14px rgba(0,0,0,.35);
  }

  /* ===== Cards ===== */
  .card{
    background:rgba(255,255,255,0.68);      /* mais transl√∫cido (cards) */
    backdrop-filter: saturate(125%);
    -webkit-backdrop-filter: saturate(125%);
    border:1px solid rgba(255,255,255,.5);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:20px; margin:18px auto;
  }
  .card h2{margin:0 0 10px;color:var(--roxo);font-size:clamp(22px,2.6vw,30px);letter-spacing:-.02em}
  .card p{margin:6px 0;color:#3b3b3b}
  .center{text-align:center}

  /* Details list */
  .details{list-style:none;padding:0;margin:0;display:grid;gap:.6rem;justify-items:center}
  .details li{display:flex;gap:.55rem;align-items:center;justify-content:center;text-align:center}
  .icon{color:var(--roxo);font-size:1.1rem;transform:translateY(1px)}

  /* Bot√µes */
  .btn{appearance:none;border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer;font-size:16px;line-height:1}
  .btn-primary{background:var(--roxo);color:#fff}
  .btn-primary:hover{background:var(--roxo-esc)}
  .btn-soft{background:var(--roxo-cl);color:var(--roxo)}
  .btn-ghost{background:#f4f4f8;color:#333}
  .row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:14px}
  .row .btn{min-width:240px}
  @media(min-width:720px){ .row.row-2 .btn{min-width:260px} }

  /* √Ålbum */
  .album{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;justify-items:center}
  .frame{width:120px;aspect-ratio:1;border-radius:12px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.08);transform:rotate(var(--tilt,0deg))}
  .frame img{width:100%;height:100%;object-fit:cover;display:block}

  /* Iframes */
  .map{width:100%;height:300px;border:0;border-radius:12px;overflow:hidden}
  .apple-embed{width:100%;max-width:680px;height:260px;border:0;border-radius:12px}

  /* Weather */
  .weather{max-width:700px;margin:0 auto}

  /* Overlay m√∫sica */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:9999}
  .overlay.hide{display:none}
  .welcome{background:#fff;width:min(92vw,520px);border-radius:16px;padding:24px 20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .welcome h3{margin:0 0 8px;color:var(--roxo);font-size:clamp(22px,2.6vw,28px)}
  .welcome p{color:#444;margin:0 0 16px}

  /* ===== Modal ‚Äúde vidro‚Äù ===== */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9998}
  .modal.open{display:flex}
  .modal-card{
    background:rgba(255,255,255,0.95);      /* MAIS BRANCO (menos transparente) */
    backdrop-filter:saturate(125%);
    -webkit-backdrop-filter:saturate(125%);
    border:1px solid rgba(255,255,255,.9);
    border-radius:16px;width:min(92vw,620px);max-height:88vh;overflow:auto;
    padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.25);
    text-align:center;
  }
  .modal-header{display:flex;align-items:center;justify-content:center;margin-bottom:10px;position:relative}
  .modal-title{font-size:22px;color:var(--roxo);font-weight:800;letter-spacing:-.02em}
  .close{position:absolute;right:8px;top:0;background:#f2effd;border:0;color:var(--roxo);width:36px;height:36px;border-radius:9px;font-size:18px;cursor:pointer}

  /* Form */
  .field{margin:10px 0}
  .label{display:block;margin:0 0 6px;font-weight:700}
  .input,.textarea,select{
    width:100%;border:2px solid #ece9ff;background:#f7f5ff;border-radius:10px;
    padding:12px 12px;font:inherit;text-align:center;
  }
  .textarea{min-height:96px;resize:vertical}

  /* RSVP ‚Äì ‚ÄúSim‚Äù primeiro e nada selecionado inicialmente */
  .yn{display:flex;gap:10px;justify-content:center}
  .yn .opt{flex:1;border-radius:10px;border:2px solid #ece9ff;background:#f7f5ff;padding:10px 12px;text-align:center;font-weight:700;cursor:pointer}
  .yn .opt.active{background:var(--roxo);color:#fff;border-color:var(--roxo)}
  .hide{display:none}

  /* Mural */
  .mural-box{min-height:66px;display:flex;align-items:center;justify-content:center;padding:12px;border-radius:12px;background:#faf8ff;color:#4a4a4a}
  .mural-msg{font-size:1.05rem;text-align:center;transition:opacity .6s ease, transform .6s ease}
  .fade-out{opacity:0;transform:translateY(8px)}
  .fade-in{opacity:1;transform:translateY(0)}
  .muted{color:var(--muted);font-size:.95rem}

  /* ===== Contagem regressiva ===== */
  .countdown{
    display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
    max-width:640px; margin:10px auto 0;
  }
  .time-box{
    background: rgba(255,255,255,0.68);
    border:1px solid rgba(255,255,255,.5);
    border-radius:12px; padding:14px 8px;
    box-shadow: var(--shadow);
  }
  .time-box .num{
    font-weight:800; font-size:clamp(26px,5vw,40px); line-height:1;
    color: var(--roxo);
  }
  .time-box .lbl{
    margin-top:6px; font-size:.9rem; color:#4a4a4a;
  }
  .countdown-note{ margin-top:8px; color:var(--muted); font-size:.95rem }
  @media (max-width:480px){
    .countdown{ grid-template-columns:repeat(2,1fr); }
  }

  /* Marca d‚Äô√°gua fixa */
  footer.watermark{
    position:fixed;left:0;right:0;bottom:4px;
    text-align:center;font-size:12px;color:#9aa0a6;opacity:.9;
    pointer-events:none;
  }

  body.modal-open{overflow:hidden}
</style>
</head>
<body>

<!-- Fundo cont√≠nuo (emba√ßado) sob os cards -->
<div class="page-bg" aria-hidden="true"></div>

<!-- Overlay Boas-vindas (MP3) -->
<div id="welcome-overlay" class="overlay">
  <div class="welcome">
    <h3>Bem-vindo(a) √† Festa da Isabella! üé∂</h3>
    <p>Toque a m√∫sica para entrar no clima da celebra√ß√£o.</p>
    <div class="row">
      <button id="start-music" class="btn btn-primary">Entrar e tocar playlist</button>
      <button id="enter-silent" class="btn btn-soft">Entrar sem m√∫sica</button>
    </div>
  </div>
</div>

<!-- Player escondido -->
<audio id="bg-audio" preload="auto" playsinline webkit-playsinline crossorigin="anonymous"></audio>

<!-- HERO -->
<header class="hero">
  <div class="hero-inner">
    <div class="hero-glow"></div>
    <div class="hero-title">
      <h1>Festa da Isabella</h1>
      <p>Celebrando seu 1¬∫ anivers√°rio</p>
    </div>
  </div>
</header>

<main class="container">

  <!-- Boas-vindas -->
  <section class="card center" id="boas-vindas">
    <h2>Boas-vindas</h2>
    <p>√â com muita alegria que convidamos voc√™ para celebrar o 1¬∫ anivers√°rio da nossa princesa Isabella! üéâüíñ</p>
    <p>Ser√° um momento especial para reunirmos fam√≠lia e amigos, com muita divers√£o, m√∫sica e boas lembran√ßas.</p>
    <p>Esperamos voc√™ para comemorar conosco esse dia t√£o importante! ü•≥‚ú®</p>
  </section>

  <!-- Mural -->
  <section class="card center" id="mural-card">
    <h2>Mural üíå</h2>
    <div class="mural-box">
      <div id="muralMessage" class="mural-msg muted">Carregando‚Ä¶</div>
    </div>
    <div class="row">
      <button id="open-mural" class="btn btn-primary">Deixar mensagem üíå</button>
    </div>
  </section>

  <!-- Informa√ß√µes -->
  <section class="card center">
    <h2>Informa√ß√µes da festa</h2>
    <ul class="details">
      <li><span class="icon">üìÖ</span>22 de novembro de 2025, 14h00‚Äì18h00</li>
      <li><span class="icon">üìç</span>S√≠tio Verdes Encantos ‚Äì Estr Zumbi dos Palmares, 286 - Tingu√°, Nova Igua√ßu - RJ, 26063-355, Brasil</li>
      <li><span class="icon">üëó</span>Traje: casual festivo</li>
    </ul>
    <div class="row row-2">
      <button id="open-rsvp" class="btn btn-primary">Confirmar presen√ßa</button>
      <a class="btn btn-soft" href="festa_da_isabella.ics" download>Adicionar ao calend√°rio</a>
    </div>
  </section>

  <!-- √Ålbum -->
  <section class="card center">
    <h2>√Ålbum de fotos</h2>
    <div class="album" id="albumPreview">
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
    </div>
    <div class="row">
      <a class="btn btn-soft" href="https://www.icloud.com/sharedalbum/#B2RJEsNWnGMlnHa" target="_blank" rel="noopener">Abrir √°lbum completo</a>
    </div>
  </section>

  <!-- Como chegar -->
  <section class="card center">
    <h2>Como chegar</h2>
    <iframe class="map" loading="lazy" allowfullscreen
      src="https://maps.google.com/maps?q=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil&t=m&z=15&ie=UTF8&iwloc=&output=embed"></iframe>
    <div class="row">
      <a class="btn btn-soft" target="_blank" rel="noopener"
        href="https://www.google.com/maps/dir/?api=1&destination=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil">Tra√ßar rota</a>
      <a class="btn btn-soft" target="_blank" rel="noopener"
        href="https://www.google.com/maps/search/?api=1&query=S%C3%ADtio%20Verdes%20Encantos%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A9u%20-%20RJ%2C%2026063-355%2C%20Brasil">Abrir no Google Maps</a>
    </div>
  </section>

  <!-- Contagem regressiva -->
  <section class="card center" id="countdown-card">
    <h2>Contagem regressiva ‚è≥</h2>
    <div class="countdown" aria-live="polite">
      <div class="time-box">
        <div id="cd-days" class="num">‚Äî</div>
        <div class="lbl">dias</div>
      </div>
      <div class="time-box">
        <div id="cd-hours" class="num">‚Äî</div>
        <div class="lbl">horas</div>
      </div>
      <div class="time-box">
        <div id="cd-mins" class="num">‚Äî</div>
        <div class="lbl">min</div>
      </div>
      <div class="time-box">
        <div id="cd-secs" class="num">‚Äî</div>
        <div class="lbl">seg</div>
      </div>
    </div>
    <div id="countdown-note" class="countdown-note">Carregando‚Ä¶</div>
  </section>

  <!-- Tempo -->
  <section class="card weather center">
    <h2>Tempo</h2>
    <div id="weatherDate" class="muted" style="margin-bottom:6px">‚Äî</div>
    <p id="weatherText">Carregando‚Ä¶</p>
    <p id="weatherSource" class="muted">Fonte: ‚Äî</p>
  </section>

</main>

<footer class="watermark">¬© 2025 Hugo Mattos. Todos os direitos reservados.</footer>

<!-- Modal MURAL -->
<div id="modal-mural" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Deixar mensagem üíå</div>
      <button class="close" data-close="modal-mural">‚úï</button>
    </div>
    <div class="field">
      <label class="label" for="mural-input">Mensagem *</label>
      <textarea id="mural-input" maxlength="140" class="textarea" placeholder="M√°x. 140 caracteres. Se quiser, assine no final (ex.: ‚Äî Fam√≠lia Silva)."></textarea>
    </div>
    <div class="row">
      <button id="mural-send" class="btn btn-primary">Publicar</button>
      <button class="btn btn-ghost" data-close="modal-mural">Cancelar</button>
    </div>
    <div id="mural-error" class="muted" style="margin-top:10px;display:none">N√£o foi poss√≠vel publicar agora. Tente de novo.</div>
  </div>
</div>

<!-- Modal RSVP -->
<div id="modal-rsvp" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Confirma√ß√£o de presen√ßa ‚ú®</div>
      <button class="close" data-close="modal-rsvp">‚úï</button>
    </div>

    <p class="muted" style="margin:0 0 10px">Preencha seus dados e envie ‚Äî abriremos o WhatsApp com a mensagem pronta.</p>

    <div class="field">
      <label class="label" for="rsvp-nome">Seu nome *</label>
      <input id="rsvp-nome" class="input" placeholder="Nome completo" />
    </div>

    <div class="field">
      <span class="label">Voc√™ vai?</span>
      <div class="yn" id="yn">
        <div data-val="sim" class="opt">Sim</div>
        <div data-val="nao" class="opt">N√£o</div>
      </div>
    </div>

    <div id="rsvp-extra" class="hide">
      <div class="field">
        <label class="label" for="rsvp-acompanha">Acompanhante</label>
        <input id="rsvp-acompanha" class="input" placeholder="Nome do(a) acompanhante (se houver)" />
      </div>
      <div class="field">
        <label class="label" for="rsvp-qtd">Qtd. filhos</label>
        <input id="rsvp-qtd" class="input" type="number" min="0" step="1" value="0"/>
      </div>
      <div class="field">
        <label class="label" for="rsvp-idades">Idades dos filhos</label>
        <input id="rsvp-idades" class="input" placeholder="Ex.: 5, 2"/>
      </div>
    </div>

    <div class="row">
      <button id="rsvp-send" class="btn btn-primary">Enviar</button>
      <button class="btn btn-ghost" data-close="modal-rsvp">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ---------- Overlay m√∫sica (robusto) ---------- */
(function(){
  const WELCOME_KEY = 'welcomeDone_v2';
  const overlay   = document.getElementById('welcome-overlay');
  const btnPlay   = document.getElementById('start-music');
  const btnSilent = document.getElementById('enter-silent');
  const audio     = document.getElementById('bg-audio');

  const mp3Path = 'assets/kids-children-baby-music-363272.mp3';
  audio.loop = true;
  audio.volume = 0.9;
  audio.src = mp3Path + '?v=' + Date.now();

  const done = sessionStorage.getItem(WELCOME_KEY) === '1';
  if (done) { overlay.classList.add('hide'); } else { document.body.classList.add('modal-open'); }

  function finishWelcome() {
    overlay.classList.add('hide');
    document.body.classList.remove('modal-open');
    sessionStorage.setItem(WELCOME_KEY,'1');
  }

  async function tryPlay() {
    try { audio.load(); await audio.play(); return true; }
    catch (e) { console.warn('Falha ao tocar √°udio:', e?.message || e); return false; }
  }

  btnPlay?.addEventListener('click', async () => {
    const ok = await tryPlay(); finishWelcome();
    if (!ok) {
      const onceClick = async () => { await tryPlay(); document.removeEventListener('click', onceClick, true); document.removeEventListener('touchend', onceClick, true); };
      document.addEventListener('click', onceClick, true);
      document.addEventListener('touchend', onceClick, true);
    }
  });

  btnSilent?.addEventListener('click', finishWelcome);

  const globalFirstTap = async () => {
    if (overlay.classList.contains('hide')) return;
    const ok = await tryPlay();
    if (ok) finishWelcome();
    document.removeEventListener('click', globalFirstTap, true);
    document.removeEventListener('touchend', globalFirstTap, true);
  };
  document.addEventListener('click', globalFirstTap, true);
  document.addEventListener('touchend', globalFirstTap, true);
})();

/* ---------- Efeito lock-screen ---------- */
(function(){
  function onScroll(){
    const hero = document.querySelector('.hero');
    if(!hero) return;
    const H = hero.offsetHeight;
    const y = Math.min(H, Math.max(0, window.scrollY));
    const p = y / H;
    document.documentElement.style.setProperty('--p', p.toFixed(3));
  }
  onScroll();
  window.addEventListener('scroll', onScroll, {passive:true});
  window.addEventListener('resize', onScroll);
})();

/* ---------- √Ålbum aleat√≥rio ---------- */
(function(){
  const srcs = [
    'album2/IMG_5139.jpeg','album2/IMG_5010.jpeg','album2/IMG_4772.jpeg',
    'album2/IMG_4765.jpeg','album2/IMG_4639.jpeg','album2/IMG_6911.jpeg',
    'album2/IMG_4450.jpeg','album2/IMG_4352.jpeg','album2/IMG_3056.jpeg',
    'album2/96f8947a-603d-43c7-b498-292922662164.jpeg'
  ];
  const frames = document.querySelectorAll('.frame img');
  const shuf = a=>a.slice().sort(()=>Math.random()-0.5);
  function fill(){
    const imgs = shuf(srcs);
    frames.forEach((img,i)=>{
      img.src = imgs[i%imgs.length];
      img.parentElement.style.setProperty('--tilt', (Math.random()*10-5)+'deg');
    });
  }
  fill(); setInterval(fill, 8000);
})();

/* ---------- Supabase (Mural) ---------- */
const SUPABASE_URL = "https://kfoousycrqscvhivhmxu.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtmb291c3ljcnFzY3ZoaXZobXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMDI1MTcsImV4cCI6MjA3MDY3ODUxN30.e55uMlW4mBmQjvG0U9WaEyqLPvjL9US3LP_9IvNTLVQ";

let supabaseClient;
(function(){
  window.supabase = null;
  const s = document.createElement('script');
  s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";
  s.onload = () => {
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{persistSession:false} });
    loadMural();
    try{
      supabaseClient.channel('public:messages')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, ()=>loadMural(true))
        .subscribe();
    }catch(_){}
  };
  document.head.appendChild(s);
})();

const muralBox = document.getElementById('muralMessage');

async function loadMural(isRealtime){
  if(!supabaseClient) return;
  try{
    const { data, error } = await supabaseClient
      .from('messages')
      .select('mensagem, created_at')
      .order('created_at',{ascending:false})
      .limit(12);
    if(error) throw error;

    const list = data?.map(d=>d.mensagem).filter(Boolean);
    if(!list?.length){
      muralBox.textContent = "Seja o primeiro a deixar um recado üíú";
      muralBox.classList.remove('muted');
      return;
    }
    muralBox.classList.remove('muted');
    let idx = 0;
    function show(i){
      muralBox.classList.add('fade-out');
      setTimeout(()=>{
        muralBox.textContent = list[i];
        muralBox.classList.remove('fade-out');
        muralBox.classList.add('fade-in');
        setTimeout(()=>muralBox.classList.remove('fade-in'), 600);
      }, 300);
    }
    show(0);
    if(!isRealtime){
      clearInterval(window._muralTimer);
      window._muralTimer = setInterval(()=>{ idx=(idx+1)%list.length; show(idx); }, 4000);
    }
  }catch(e){
    muralBox.textContent = "N√£o foi poss√≠vel carregar as mensagens agora.";
    muralBox.classList.add('muted');
  }
}

/* ---------- Modais ---------- */
function openModal(id){ document.getElementById(id).classList.add('open'); document.body.classList.add('modal-open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); document.body.classList.remove('modal-open'); }
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
document.getElementById('open-mural')?.addEventListener('click',()=>openModal('modal-mural'));
document.getElementById('open-rsvp')?.addEventListener('click',()=>openModal('modal-rsvp'));

/* ---------- Enviar mural ---------- */
document.getElementById('mural-send')?.addEventListener('click', async ()=>{
  const t = document.getElementById('mural-input').value.trim();
  const err = document.getElementById('mural-error');
  if(t.length<2){ err.textContent="Escreva ao menos 2 caracteres üôÇ"; err.style.display='block'; return; }
  err.style.display='none';
  try{
    const { error } = await supabaseClient.from('messages').insert({ mensagem: t });
    if(error) throw error;
    document.getElementById('mural-input').value='';
    closeModal('modal-mural');
    loadMural(true);
  }catch(e){
    err.textContent="N√£o foi poss√≠vel publicar agora. Tente de novo.";
    err.style.display='block';
  }
});

/* ---------- Contagem regressiva ---------- */
(function(){
  const EVENT_DATE = '2025-11-22';
  const EVENT_TIME = '14:00:00';   // ajuste se necess√°rio
  const TZ_OFFSET  = '-03:00';     // BRT

  const target = new Date(`${EVENT_DATE}T${EVENT_TIME}${TZ_OFFSET}`);

  const elD = document.getElementById('cd-days');
  const elH = document.getElementById('cd-hours');
  const elM = document.getElementById('cd-mins');
  const elS = document.getElementById('cd-secs');
  const note = document.getElementById('countdown-note');

  function tick(){
    const now = new Date();
    let ms = target - now;

    if (ms <= 0){
      elD.textContent='0'; elH.textContent='0'; elM.textContent='0'; elS.textContent='0';
      note.textContent='√â hoje! üéâ Nos vemos na festa ‚ú®';
      return;
    }
    const sec=1000, min=60*sec, hour=60*min, day=24*hour;
    const d=Math.floor(ms/day); ms%=day;
    const h=Math.floor(ms/hour); ms%=hour;
    const m=Math.floor(ms/min);  ms%=min;
    const s=Math.floor(ms/sec);

    elD.textContent=d; elH.textContent=h; elM.textContent=m; elS.textContent=s;
    note.textContent = d>0 ? `Faltam ${d} dia${d>1?'s':''} para a festa üéà`
                           : `Faltam ${h}h ${m}m ${s}s üéà`;
  }
  tick();
  setInterval(tick, 1000);
})();

/* ---------- RSVP (WhatsApp) ‚Äì mensagens no formato solicitado ---------- */
(function(){
  const yn = document.getElementById('yn');
  const extra = document.getElementById('rsvp-extra');
  let going = null;                        // come√ßa sem sele√ß√£o

  yn.querySelectorAll('.opt').forEach(opt=>{
    opt.addEventListener('click',()=>{
      yn.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
      opt.classList.add('active');
      going = opt.dataset.val;
      extra.classList.toggle('hide', going!=='sim');
    });
  });

  function wppLink(txt){
    const phone = '5521993835163';
    return `https://wa.me/${phone}?text=${encodeURIComponent(txt)}`;
  }

  document.getElementById('rsvp-send')?.addEventListener('click',()=>{
    const nome = document.getElementById('rsvp-nome').value.trim();
    if(!nome){ alert('Informe seu nome.'); return; }
    if(!going){ alert('Escolha se voc√™ vai ou n√£o.'); return; }

    if(going==='nao'){
      const msg = `Ol√°! Infelizmente n√£o poderei comparecer ao anivers√°rio da Isabella üòî

‚Ä¢ Nome: ${nome}`;
      window.open(wppLink(msg),'_blank','noopener');
      closeModal('modal-rsvp');
      return;
    }

    const acomp  = (document.getElementById('rsvp-acompanha').value.trim() || '‚Äî');
    const qtd    = (document.getElementById('rsvp-qtd').value.trim() || '‚Äî');
    const idades = (document.getElementById('rsvp-idades').value.trim() || '‚Äî');

    const msg = `Ol√°! Confirmo minha presen√ßa no anivers√°rio da Isabella üéâ

‚Ä¢ Nome: ${nome}
‚Ä¢ Acompanhante: ${acomp}
‚Ä¢ Qtd Filhos: ${qtd}
‚Ä¢ Idade dos Filhos: ${idades}`;

    window.open(wppLink(msg),'_blank','noopener');
    closeModal('modal-rsvp');
  });
})();

/* ---------- Tempo (Open-Meteo) ---------- */
(function(){
  const EVENT_DATE = '2025-11-22';
  const LAT=-22.606, LON=-43.490, TZ='America/Sao_Paulo';
  const elDate=document.getElementById('weatherDate'), elText=document.getElementById('weatherText'), elSrc=document.getElementById('weatherSource');
  elDate.textContent = new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'long'}).format(new Date(EVENT_DATE+'T12:00:00'));

  function daysTo(iso){const t=new Date();t.setHours(0,0,0,0);const e=new Date(iso+'T00:00:00');return Math.round((e-t)/86400000);}
  const dLeft=daysTo(EVENT_DATE);

  async function daily(){
    const u=new URL('https://api.open-meteo.com/v1/forecast');
    u.search=new URLSearchParams({latitude:LAT,longitude:LON,timezone:TZ,daily:'temperature_2m_max,temperature_2m_min,precipitation_probability_mean',start_date:EVENT_DATE,end_date:EVENT_DATE});
    const r=await fetch(u); if(!r.ok) throw 0; return r.json();
  }
  async function clim(){
    const u=new URL('https://climate-api.open-meteo.com/v1/climate');
    u.search=new URLSearchParams({latitude:LAT,longitude:LON,start_year:1991,end_year:2020,models:'ERA5',monthly:'temperature_2m_max_mean,temperature_2m_min_mean,precipitation_probability_mean',month:11});
    const r=await fetch(u); if(!r.ok) throw 0; return r.json();
  }
  function srcStamp(name){
    const now=new Date();
    const stamp=new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',timeZone:TZ}).format(now).replace('.','');
    elSrc.innerHTML=`Fonte: <a href="https://open-meteo.com/" target="_blank" rel="noopener">${name}</a> ‚Ä¢ Atualizado em ${stamp} (BRT)`;
  }

  (async()=>{
    try{
      if(dLeft>=0 && dLeft<=16){
        const d=await daily(); const tmax=Math.round(d.daily.temperature_2m_max[0]); const tmin=Math.round(d.daily.temperature_2m_min[0]); const p=d.daily.precipitation_probability_mean?.[0];
        elText.textContent = (typeof p==='number')?`Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞, chance de chuva ${p}%`:`Previs√£o: entre ${tmin}¬∞ e ${tmax}¬∞`;
        srcStamp('Open-Meteo (previs√£o di√°ria)');
      }else{
        const c=await clim(); const m=c.monthly||{}; const tmax=Math.round(m.temperature_2m_max_mean?.[0]??27); const tmin=Math.round(m.temperature_2m_min_mean?.[0]??20);
        elText.textContent=`Nesta √©poca do ano, a temperatura costuma variar entre ${tmin}¬∞ e ${tmax}¬∞.`;
        srcStamp('Open-Meteo (climatologia 1991‚Äì2020)');
      }
    }catch(e){
      elText.textContent='Nesta √©poca do ano, a temperatura costuma variar entre 20¬∞ e 27¬∞.'; srcStamp('Open-Meteo');
    }
  })();
})();
</script>
</body>
</html>
