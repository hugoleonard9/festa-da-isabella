<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Festa da Isabella</title>
<meta name="theme-color" content="#5b3fa2"/>

<style>
  :root{
    --roxo:#5b3fa2;--roxo-esc:#493183;--roxo-cl:#efe8ff;
    --txt:#262626;--muted:#6b7280;--white:#fff;
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    color:var(--txt);line-height:1.55;background:transparent;
  }
  a{color:var(--roxo);text-decoration:none}
  .container{max-width:980px;margin:0 auto;padding:22px 16px}

  /* ————————— FUNDO 100% DESFOCADO ————————— */
  .bg-blur{
    position:fixed;inset:0;z-index:-2;
    background:url('hero.jpg') center/cover no-repeat;
    filter:blur(22px);
    transform:scale(1.08); /* evita bordas do blur */
  }
  .bg-veil{
    position:fixed;inset:0;z-index:-1;
    background:linear-gradient(to bottom, rgba(255,255,255,.08), rgba(255,255,255,.28) 45%, rgba(255,255,255,.35));
  }

  /* ————————— HERO + TÍTULO “VIDRO” ————————— */
  .hero{
    position:relative;height:60vh;min-height:360px;
    background:url('hero.jpg') center/cover no-repeat;
    display:flex;align-items:flex-end;justify-content:center;
    text-align:center;overflow:hidden;
  }
  /* vinheta superior para ícones do SO */
  .hero::before{
    content:"";position:absolute;inset:0 0 40% 0;
    background:linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0));
    pointer-events:none;
  }

  /* cápsula de vidro do título */
  .title-wrap{
    position:relative;margin:0 16px 18px;padding:18px 22px 16px;
    border-radius:26px;
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.45);
    color:#fff; box-shadow:0 18px 50px rgba(0,0,0,.32);
    -webkit-backdrop-filter:blur(22px) saturate(120%);
            backdrop-filter:blur(22px) saturate(120%);
  }
  /* brilho interno (halo) para ficar mais iOS-like */
  .title-wrap::before{
    content:"";position:absolute;inset:0;border-radius:26px;
    background:
      radial-gradient(120% 120% at 50% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 60%) ,
      linear-gradient(to bottom, rgba(255,255,255,.18), rgba(255,255,255,.06));
    pointer-events:none;mix-blend:screen;opacity:.85;
  }
  /* sombra “borrada” no rodapé do título (transição suave) */
  .title-wrap::after{
    content:"";position:absolute;left:-6%;right:-6%;bottom:-26px;height:64px;
    filter:blur(18px);
    background:radial-gradient(120% 120% at 50% -10%, rgba(0,0,0,.45), transparent 70%);
    pointer-events:none;
  }
  .hero h1{
    margin:0 0 8px;font-weight:800;
    font-size:clamp(36px,6vw,56px);letter-spacing:-.02em;
    text-shadow:0 6px 22px rgba(0,0,0,.45);
  }
  .hero .sub{
    margin:0;opacity:.98;font-weight:600;
    font-size:clamp(14px,2.4vw,18px);
  }

  /* ————————— CARDS (sem blur no próprio card) ————————— */
  .card{
    background:rgba(255,255,255,.92);
    border:1px solid rgba(255,255,255,.6);
    border-radius:var(--radius);
    box-shadow:0 20px 50px rgba(30,30,60,.18);
    padding:22px;margin:18px auto;
  }
  .card h2{margin:0 0 12px;color:var(--roxo);font-size:clamp(22px,2.6vw,30px);letter-spacing:-.02em}
  .card p{margin:6px 0;color:#3b3b3b}
  .center{text-align:center}

  /* Detalhes */
  .details{list-style:none;padding:0;margin:0;display:grid;gap:.7rem;justify-items:center}
  .details li{display:flex;gap:.6rem;align-items:center;justify-content:center;text-align:center}
  .icon{color:var(--roxo);font-size:1.1rem;transform:translateY(1px)}

  /* Botões (tamanho consistente) */
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 20px;font-weight:800;cursor:pointer;font-size:16px;line-height:1}
  .btn-primary{background:var(--roxo);color:#fff}
  .btn-primary:hover{background:var(--roxo-esc)}
  .btn-soft{background:var(--roxo-cl);color:var(--roxo)}
  .btn-ghost{background:#f4f4f8;color:#333}
  .row{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:14px}
  .row .btn{min-width:240px}
  @media(min-width:720px){.row.row-2 .btn{min-width:260px}}

  /* Álbum */
  .album{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;justify-items:center}
  .frame{width:120px;aspect-ratio:1;border-radius:14px;overflow:hidden;box-shadow:0 6px 16px rgba(0,0,0,.08);transform:rotate(var(--tilt,0deg))}
  .frame img{width:100%;height:100%;object-fit:cover;display:block}

  /* Iframes */
  .map{width:100%;height:300px;border:0;border-radius:16px;overflow:hidden}
  .apple-embed{width:100%;max-width:680px;height:260px;border:0;border-radius:16px}

  /* Tempo */
  .weather{max-width:700px;margin:0 auto}

  /* Overlay Boas‑vindas (música) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);
           -webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px);
           display:flex;align-items:center;justify-content:center;z-index:9999}
  .overlay.hide{display:none}
  .welcome{background:#fff;width:min(92vw,520px);border-radius:18px;padding:24px 20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .welcome h3{margin:0 0 8px;color:var(--roxo);font-size:clamp(22px,2.6vw,28px)}
  .welcome p{color:#444;margin:0 0 16px}

  /* Modais */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9998}
  .modal.open{display:flex}
  .modal-card{background:#fff;border-radius:18px;width:min(92vw,620px);max-height:88vh;overflow:auto;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-title{font-size:22px;color:var(--roxo);font-weight:800;letter-spacing:-.02em}
  .close{background:#f2effd;border:0;color:var(--roxo);width:36px;height:36px;border-radius:9px;font-size:18px;cursor:pointer}

  /* Form */
  .field{margin:10px 0}
  .label{display:block;margin:0 0 6px;font-weight:700}
  .input,.textarea,select{width:100%;border:2px solid #ece9ff;background:#f7f5ff;border-radius:12px;padding:12px 12px;font:inherit}
  .textarea{min-height:96px;resize:vertical}
  .yn{display:flex;gap:10px}
  .yn .opt{flex:1;border-radius:12px;border:2px solid #ece9ff;background:#f7f5ff;padding:12px;text-align:center;font-weight:800;cursor:pointer}
  .yn .opt.active{background:var(--roxo);color:#fff;border-color:var(--roxo)}

  /* Mural rotativo */
  .mural-box{min-height:66px;display:flex;align-items:center;justify-content:center;padding:12px;border-radius:14px;background:#faf8ff;color:#4a4a4a}
  .mural-msg{font-size:1.05rem;text-align:center;transition:opacity .6s ease, transform .6s ease}
  .fade-out{opacity:0;transform:translateY(8px)}
  .fade-in{opacity:1;transform:translateY(0)}
  .muted{color:var(--muted);font-size:.95rem}

  /* Marca d’água fixa */
  footer.watermark{
    position:fixed;left:0;right:0;bottom:12px;text-align:center;
    font-size:12px;color:#9aa0a6;opacity:.9;pointer-events:none;
  }

  /* Evita rolagem com modal/overlay */
  body.modal-open{overflow:hidden}
</style>
</head>
<body>

<!-- Fundo 100% desfocado -->
<div class="bg-blur" aria-hidden="true"></div>
<div class="bg-veil" aria-hidden="true"></div>

<!-- Overlay música -->
<div id="welcome-overlay" class="overlay">
  <div class="welcome">
    <h3>Bem‑vindo(a) à Festa da Isabella! 🎶</h3>
    <p>Toque a música para entrar no clima da celebração.</p>
    <div class="row">
      <button id="start-music" class="btn btn-primary">Entrar e tocar playlist</button>
      <button id="enter-silent" class="btn btn-soft">Entrar sem música</button>
    </div>
  </div>
</div>

<!-- Player (src definido via JS p/ atualizar o MP3) -->
<audio id="bg-audio" preload="auto" playsinline webkit-playsinline></audio>

<!-- HERO com título “vidro” -->
<header class="hero" role="img" aria-label="Isabella sorrindo">
  <div class="title-wrap">
    <h1>Festa da Isabella</h1>
    <p class="sub">Celebrando seu 1º aniversário</p>
  </div>
</header>

<main class="container">
  <!-- Boas‑vindas -->
  <section class="card center" id="boas-vindas">
    <h2>Boas‑vindas</h2>
    <p>É com muita alegria que convidamos você para celebrar o 1º aniversário da nossa princesa Isabella! 🎉💖</p>
    <p>Será um momento especial para reunirmos família e amigos, com muita diversão, música e boas lembranças.</p>
    <p>Esperamos você para comemorar conosco esse dia tão importante! 🥳✨</p>
  </section>

  <!-- Mural -->
  <section class="card center" id="mural-card">
    <h2>Mural 💌</h2>
    <div class="mural-box">
      <div id="muralMessage" class="mural-msg muted">Carregando…</div>
    </div>
    <div class="row">
      <button id="open-mural" class="btn btn-primary">Deixar mensagem 💌</button>
    </div>
  </section>

  <!-- Informações -->
  <section class="card center">
    <h2>Informações da festa</h2>
    <ul class="details">
      <li><span class="icon">📅</span>22 de novembro de 2025, 14h00–18h00</li>
      <li><span class="icon">📍</span>Sítio Verdes Encantos – Estr Zumbi dos Palmares, 286 - Tinguá, Nova Iguaçu - RJ, 26063-355, Brasil</li>
      <li><span class="icon">👗</span>Traje: casual festivo</li>
    </ul>
    <div class="row row-2">
      <button id="open-rsvp" class="btn btn-primary">Confirmar presença</button>
      <a class="btn btn-soft" href="festa_da_isabella.ics" download>Adicionar ao calendário</a>
    </div>
  </section>

  <!-- Álbum -->
  <section class="card center">
    <h2>Álbum de fotos</h2>
    <div class="album" id="albumPreview">
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
      <div class="frame"><img alt=""></div>
    </div>
    <div class="row">
      <a class="btn btn-soft" href="https://www.icloud.com/sharedalbum/#B2RJEsNWnGMlnHa" target="_blank" rel="noopener">Abrir álbum completo</a>
    </div>
  </section>

  <!-- Como chegar -->
  <section class="card center">
    <h2>Como chegar</h2>
    <iframe class="map" loading="lazy" allowfullscreen
      src="https://maps.google.com/maps?q=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil&t=m&z=15&ie=UTF8&iwloc=&output=embed"></iframe>
    <div class="row">
      <a class="btn btn-soft" target="_blank" rel="noopener"
        href="https://www.google.com/maps/dir/?api=1&destination=S%C3%ADtio%20Verdes%20Encantos%20-%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil">Traçar rota</a>
      <a class="btn btn-soft" target="_blank" rel="noopener"
        href="https://www.google.com/maps/search/?api=1&query=S%C3%ADtio%20Verdes%20Encantos%20Estr%20Zumbi%20dos%20Palmares%2C%20286%20-%20Tingu%C3%A1%2C%20Nova%20Igua%C3%A7u%20-%20RJ%2C%2026063-355%2C%20Brasil">Abrir no Google Maps</a>
    </div>
  </section>

  <!-- Presentes -->
  <section class="card center">
    <h2>Sugestão de presentes 💝</h2>
    <ul class="details">
      <li><span class="icon">🧸</span>Brinquedos educativos</li>
      <li><span class="icon">👗</span>Roupas tamanho 2 anos (cores suaves)</li>
      <li><span class="icon">🥿</span>Calçados a partir do tamanho 22</li>
    </ul>
    <div class="row">
      <a class="btn btn-soft" target="_blank" rel="noopener"
        href="https://wa.me/5521993835163?text=Oi%2C%20tenho%20uma%20d%C3%BAvida%20sobre%20o%20presente%20da%20Isabella">Dúvidas sobre o presente</a>
    </div>
  </section>

  <!-- Playlist Apple Music -->
  <section class="card center">
    <h2>Playlist da festa</h2>
    <iframe class="apple-embed"
      allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
      sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
      src="https://embed.music.apple.com/br/playlist/playlist-festa-da-isabella/pl.u-MRjJtWNaq0M"></iframe>
  </section>

  <!-- Tempo -->
  <section class="card weather center">
    <h2>Tempo</h2>
    <div id="weatherDate" class="muted" style="margin-bottom:6px">—</div>
    <p id="weatherText">Carregando…</p>
    <p id="weatherSource" class="muted">Fonte: —</p>
  </section>
</main>

<!-- Marca d’água -->
<footer class="watermark">© 2025 Hugo Mattos. Todos os direitos reservados.</footer>

<!-- Modal Mural -->
<div id="modal-mural" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Deixar mensagem 💌</div>
      <button class="close" data-close="modal-mural">✕</button>
    </div>
    <div class="field">
      <label class="label" for="mural-input">Mensagem *</label>
      <textarea id="mural-input" maxlength="140" class="textarea" placeholder="Máx. 140 caracteres. Se quiser, assine no final (ex.: — Família Silva)."></textarea>
    </div>
    <div class="row">
      <button id="mural-send" class="btn btn-primary">Publicar</button>
      <button class="btn btn-ghost" data-close="modal-mural">Cancelar</button>
    </div>
    <div id="mural-error" class="muted" style="margin-top:10px;display:none">Não foi possível publicar agora. Tente de novo.</div>
  </div>
</div>

<!-- Modal RSVP -->
<div id="modal-rsvp" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">Confirmação de presença ✨</div>
      <button class="close" data-close="modal-rsvp">✕</button>
    </div>

    <p class="muted" style="margin:0 0 10px">Preencha seus dados e envie — abriremos o WhatsApp com a mensagem pronta.</p>

    <div class="field">
      <label class="label" for="rsvp-nome">Seu nome *</label>
      <input id="rsvp-nome" class="input" placeholder="Nome completo" />
    </div>

    <div class="field">
      <span class="label">Você vai?</span>
      <div class="yn" id="yn">
        <div data-val="nao" class="opt">Não</div>
        <div data-val="sim" class="opt active">Sim</div>
      </div>
    </div>

    <div id="rsvp-extra">
      <div class="field">
        <label class="label" for="rsvp-acompanha">Acompanhante</label>
        <input id="rsvp-acompanha" class="input" placeholder="Nome do(a) acompanhante (se houver)" />
      </div>
      <div class="field">
        <label class="label" for="rsvp-qtd">Qtd. filhos</label>
        <input id="rsvp-qtd" class="input" type="number" min="0" step="1" value="0"/>
      </div>
      <div class="field">
        <label class="label" for="rsvp-idades">Idades dos filhos</label>
        <input id="rsvp-idades" class="input" placeholder="Ex.: 5, 2"/>
      </div>
    </div>

    <div class="row">
      <button id="rsvp-send" class="btn btn-primary">Enviar</button>
      <button class="btn btn-ghost" data-close="modal-rsvp">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ————— Overlay música ————— */
(function(){
  const WELCOME_KEY = 'welcomeDone_v2';
  const overlay = document.getElementById('welcome-overlay');
  const btnPlay = document.getElementById('start-music');
  const btnSilent = document.getElementById('enter-silent');
  const audio = document.getElementById('bg-audio');

  // força atualização do MP3 (cache-buster)
  const mp3Path = 'assets/kids-children-baby-music-363272.mp3';
  audio.src = mp3Path + '?v=' + Date.now();

  const done = sessionStorage.getItem(WELCOME_KEY)==='1';
  if(done) overlay.classList.add('hide'); else document.body.classList.add('modal-open');

  function closeOverlay(){
    overlay.classList.add('hide');
    document.body.classList.remove('modal-open');
    sessionStorage.setItem(WELCOME_KEY,'1');
  }

  btnPlay?.addEventListener('click', async ()=>{
    try{ audio.pause(); audio.currentTime=0; audio.muted=false; await audio.play(); }catch(e){}
    closeOverlay();
  });
  btnSilent?.addEventListener('click', closeOverlay);
})();

/* ————— Álbum (shuffle) ————— */
(function(){
  const srcs=[
    'album2/IMG_5139.jpeg','album2/IMG_5010.jpeg','album2/IMG_4772.jpeg',
    'album2/IMG_4765.jpeg','album2/IMG_4639.jpeg','album2/IMG_6911.jpeg',
    'album2/IMG_4450.jpeg','album2/IMG_4352.jpeg','album2/IMG_3056.jpeg',
    'album2/96f8947a-603d-43c7-b498-292922662164.jpeg'
  ];
  const frames=document.querySelectorAll('.frame img');
  const shuf=a=>a.slice().sort(()=>Math.random()-0.5);
  function fill(){
    const imgs=shuf(srcs);
    frames.forEach((img,i)=>{
      img.src=imgs[i%imgs.length];
      img.parentElement.style.setProperty('--tilt',(Math.random()*10-5)+'deg');
    });
  }
  fill(); setInterval(fill,8000);
})();

/* ————— Supabase (mural) ————— */
const SUPABASE_URL="https://kfoousycrqscvhivhmxu.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtmb291c3ljcnFzY3ZoaXZobXh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMDI1MTcsImV4cCI6MjA3MDY3ODUxN30.e55uMlW4mBmQjvG0U9WaEyqLPvjL9US3LP_9IvNTLVQ";

let supabaseClient;
(function(){
  window.supabase=null;
  const s=document.createElement('script');
  s.src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js";
  s.onload=()=>{
    supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON,{auth:{persistSession:false}});
    loadMural();
    try{
      supabaseClient.channel('public:messages')
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},()=>loadMural(true))
        .subscribe();
    }catch(_){}
  };
  document.head.appendChild(s);
})();

const muralBox=document.getElementById('muralMessage');

async function loadMural(isRealtime){
  if(!supabaseClient) return;
  try{
    const {data,error}=await supabaseClient
      .from('messages').select('mensagem,created_at')
      .order('created_at',{ascending:false}).limit(12);
    if(error) throw error;

    const list=data?.map(d=>d.mensagem).filter(Boolean);
    if(!list?.length){
      muralBox.textContent="Seja o primeiro a deixar um recado 💜";
      muralBox.classList.remove('muted');return;
    }
    muralBox.classList.remove('muted');
    let idx=0;
    function show(i){
      muralBox.classList.add('fade-out');
      setTimeout(()=>{
        muralBox.textContent=list[i];
        muralBox.classList.remove('fade-out');
        muralBox.classList.add('fade-in');
        setTimeout(()=>muralBox.classList.remove('fade-in'),600);
      },300);
    }
    show(0);
    if(!isRealtime){
      clearInterval(window._muralTimer);
      window._muralTimer=setInterval(()=>{idx=(idx+1)%list.length;show(idx);},4000);
    }
  }catch(e){
    muralBox.textContent="Não foi possível carregar as mensagens agora.";
    muralBox.classList.add('muted');
  }
}

/* ————— Modais ————— */
function openModal(id){document.getElementById(id).classList.add('open');document.body.classList.add('modal-open');}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.classList.remove('modal-open');}
document.querySelectorAll('[data-close]').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
document.getElementById('open-mural')?.addEventListener('click',()=>openModal('modal-mural'));
document.getElementById('open-rsvp')?.addEventListener('click',()=>openModal('modal-rsvp'));

/* ————— Enviar mural ————— */
document.getElementById('mural-send')?.addEventListener('click',async()=>{
  const t=document.getElementById('mural-input').value.trim();
  const err=document.getElementById('mural-error');
  if(t.length<2){err.textContent="Escreva ao menos 2 caracteres 🙂";err.style.display='block';return;}
  err.style.display='none';
  try{
    const {error}=await supabaseClient.from('messages').insert({mensagem:t});
    if(error) throw error;
    document.getElementById('mural-input').value='';
    closeModal('modal-mural');loadMural(true);
  }catch(e){
    err.textContent="Não foi possível publicar agora. Tente de novo.";
    err.style.display='block';
  }
});

/* ————— RSVP (WhatsApp) ————— */
(function(){
  const yn=document.getElementById('yn');
  const extra=document.getElementById('rsvp-extra');
  let going='sim';
  yn.querySelectorAll('.opt').forEach(opt=>{
    opt.addEventListener('click',()=>{
      yn.querySelectorAll('.opt').forEach(o=>o.classList.remove('active'));
      opt.classList.add('active');going=opt.dataset.val;
      extra.style.display=(going==='sim')?'block':'none';
    });
  });
  extra.style.display='block';

  function wppLink(txt){const phone='5521993835163';return `https://wa.me/${phone}?text=${encodeURIComponent(txt)}`;}

  document.getElementById('rsvp-send')?.addEventListener('click',()=>{
    const nome=document.getElementById('rsvp-nome').value.trim();
    if(!nome){alert('Informe seu nome.');return;}

    if(going==='nao'){
      const msg=`Olá! Aqui é ${nome}. Infelizmente, NÃO poderei ir ao aniversário da Isabella. 💜`;
      window.open(wppLink(msg),'_blank','noopener');closeModal('modal-rsvp');return;
    }

    const acomp=document.getElementById('rsvp-acompanha').value.trim();
    const qtd=document.getElementById('rsvp-qtd').value.trim()||'0';
    const idades=document.getElementById('rsvp-idades').value.trim();

    let msg=`Olá! Aqui é ${nome}. Confirmo presença no aniversário da Isabella. 🎉`;
    if(acomp) msg+=`\nAcompanhante: ${acomp}`;
    msg+=`\nFilhos: ${qtd}`;
    if(idades) msg+=`\nIdades: ${idades}`;
    window.open(wppLink(msg),'_blank','noopener');closeModal('modal-rsvp');
  });
})();

/* ————— Tempo (Open‑Meteo) ————— */
(function(){
  const EVENT_DATE='2025-11-22';
  const LAT=-22.606, LON=-43.490, TZ='America/Sao_Paulo';
  const elDate=document.getElementById('weatherDate'), elText=document.getElementById('weatherText'), elSrc=document.getElementById('weatherSource');
  elDate.textContent=new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'long'}).format(new Date(EVENT_DATE+'T12:00:00'));

  function daysTo(iso){const t=new Date();t.setHours(0,0,0,0);const e=new Date(iso+'T00:00:00');return Math.round((e-t)/86400000);}
  const dLeft=daysTo(EVENT_DATE);

  async function daily(){
    const u=new URL('https://api.open-meteo.com/v1/forecast');
    u.search=new URLSearchParams({latitude:LAT,longitude:LON,timezone:TZ,daily:'temperature_2m_max,temperature_2m_min,precipitation_probability_mean',start_date:EVENT_DATE,end_date:EVENT_DATE});
    const r=await fetch(u); if(!r.ok) throw 0; return r.json();
  }
  async function clim(){
    const u=new URL('https://climate-api.open-meteo.com/v1/climate');
    u.search=new URLSearchParams({latitude:LAT,longitude:LON,start_year:1991,end_year:2020,models:'ERA5',monthly:'temperature_2m_max_mean,temperature_2m_min_mean,precipitation_probability_mean',month:11});
    const r=await fetch(u); if(!r.ok) throw 0; return r.json();
  }
  function srcStamp(name){
    const now=new Date();
    const stamp=new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit',timeZone:TZ}).format(now).replace('.','');
    elSrc.innerHTML=`Fonte: <a href="https://open-meteo.com/" target="_blank" rel="noopener">${name}</a> • Atualizado em ${stamp} (BRT)`;
  }

  (async()=>{
    try{
      if(dLeft>=0 && dLeft<=16){
        const d=await daily(); const tmax=Math.round(d.daily.temperature_2m_max[0]); const tmin=Math.round(d.daily.temperature_2m_min[0]); const p=d.daily.precipitation_probability_mean?.[0];
        elText.textContent=(typeof p==='number')?`Previsão: entre ${tmin}° e ${tmax}°, chance de chuva ${p}%`:`Previsão: entre ${tmin}° e ${tmax}°`;
        srcStamp('Open‑Meteo (previsão diária)');
      }else{
        const c=await clim(); const m=c.monthly||{}; const tmax=Math.round(m.temperature_2m_max_mean?.[0]??27); const tmin=Math.round(m.temperature_2m_min_mean?.[0]??20);
        elText.textContent=`Nesta época do ano, a temperatura costuma variar entre ${tmin}° e ${tmax}°.`;
        srcStamp('Open‑Meteo (climatologia 1991–2020)');
      }
    }catch(e){
      elText.textContent='Nesta época do ano, a temperatura costuma variar entre 20° e 27°.'; srcStamp('Open‑Meteo');
    }
  })();
})();
</script>
</body>
</html>
